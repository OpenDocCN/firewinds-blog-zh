<html>
<head>
<title>Introducing RBAC Manager: Simplifying Kubernetes RBAC Management</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>介绍RBAC经理:简化Kubernetes RBAC管理</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/introducing-rbac-manager-simplifying-kubernetes-rbac-management#2019-12-17">https://www.fairwinds.com/blog/introducing-rbac-manager-simplifying-kubernetes-rbac-management#2019-12-17</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p name="7323" id="7323" class="graf graf--p graf-after--figure">在<span> <a href="/" rel=" noopener"> Fairwinds </a> </span> <span>，</span>我们用Kubernetes帮助一些大公司。与这么多不同的组织合作让我们对大规模维护Kubernetes所涉及的一些挑战有了独特的看法。</p>

<p name="fce1" id="fce1" class="graf graf--p graf-after--p">我们看到组织与Kubernetes斗争的最常见领域之一是管理RBAC。对于许多组织来说，这是如此的困难和令人困惑，以至于RBAC经常甚至没有实现，或者只实现了一半。对于设法正确锁定RBAC配置的组织来说，他们经常发现配置很难维护。</p>
<blockquote name="530f" id="530f" class="graf graf--blockquote graf-after--p"><em>缺乏适当的RBAC配置通常会导致太多的人过多地访问太多的Kubernetes集群。</em></blockquote>
<p name="9d5b" id="9d5b" class="graf graf--p graf-after--blockquote">在亲眼目睹了RBAC配置在规模上的挑战性之后，我们构建了一个开源的Kubernetes操作器来提供帮助。今天我们介绍的是<span> </span> <a href="https://github.com/reactiveops/rbac-manager" data-href="https://github.com/reactiveops/rbac-manager" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank"> RBAC经理</a>。我们希望这个项目能够帮助那些正在努力管理他们当前的RBAC配置的组织，并且鼓励更多的组织在他们的Kubernetes实现中完全采用RBAC。</p>
<h2 id="cf26" class="graf graf--h3 graf-after--p">RBAC管理当前面临的挑战</h2>
<p name="5583" id="5583" class="graf graf--p graf-after--h3">为了充分理解我们对RBAC管理器的目标，有必要花一些时间来理解RBAC配置目前如何与Kubernetes一起工作。让我们从一个非常简单的单用户例子开始。我们称这个用户为“A”，他们需要<span> </span> <code class="markup--code markup--p-code">edit</code> <span> </span>访问集群中的<span> </span> <code class="markup--code markup--p-code">web</code> <span> </span>和<span> </span> <code class="markup--code markup--p-code">api</code>名称空间。为此，我们将创建2个新的角色绑定:</p>
<pre><code>
kind: RoleBinding 
apiVersion: rbac.authorization.k8s.io/v1 
metadata: 
    name: example 
    namespace: web 
subjects: 
  - kind: User 
    name: A 
    apiGroup: rbac.authorization.k8s.io 
roleRef: 
    kind: ClusterRole 
    name: edit 
    apiGroup: rbac.authorization.k8s.io 
--- 
kind: RoleBinding 
apiVersion: rbac.authorization.k8s.io/v1 
metadata: 
    name: example 
    namespace: api 
subjects: 
  - kind: 
    User name: A 
    apiGroup: rbac.authorization.k8s.io 
roleRef: 
    kind: ClusterRole 
    name: edit 
    apiGroup: rbac.authorization.k8s.io</code></pre>
<p name="71e4" id="71e4" class="graf graf--p graf-after--figure">当然，这并不特别复杂，但是对于单个用户来说，这是一个非常简单的配置。当我们引入更多的用户、名称空间或集群时，这变得更加复杂。</p>
<p name="27a0" id="27a0" class="graf graf--p graf-after--p">随着规模的扩大，不可避免地需要所有的YAML配置，很快就很难对其进行跟踪。获取用户列表并查看他们每个人在集群中的访问级别是一个令人望而生畏的过程。</p>
<p name="ecd1" id="ecd1" class="graf graf--p graf-after--p">此外，如果我们想要在其中一个名称空间中更改该用户的访问级别，这可能不像您希望的那么简单。没有办法把一个<span> </span> <code class="markup--code markup--p-code">roleRef</code> <span> </span>换成一个<span> </span> <code class="markup--code markup--p-code">RoleBinding</code>。该方法包括删除一个<span> </span> <code class="markup--code markup--p-code">RoleBinding</code> <span> </span>并代之以用更新的<span> </span> <code class="markup--code markup--p-code">roleRef</code>创建一个新的。</p>
<p name="e480" id="e480" class="graf graf--p graf-after--p">在越来越多地由自动化驱动的工作流中，作为代码的基础设施通常被视为黄金标准，这并不十分合适。这还不包括在任何规模上管理删除角色绑定会有多困难。你不能只是从回购协议中删除一个<span> </span> <code class="markup--code markup--p-code">RoleBinding</code> <span> </span>，然后指望某种自动化任务来为你管理变更。</p>
<p name="fa1d" id="fa1d" class="graf graf--p graf-after--p">现在当然可以修改Kubernetes角色和集群角色。为了获得最细粒度的结果，可以为每个角色绑定创建唯一的角色和集群角色，然后修改角色，而不是角色绑定。尽管在某些情况下这无疑是一个很好的解决方案，但是在任何规模上管理这些角色都会变得非常复杂。我们的目标是简化RBAC管理，因此，我们希望利用Kubernetes为我们的工作流提供的<span> </span> <a href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" data-href="https://kubernetes.io/docs/reference/access-authn-authz/rbac/#default-roles-and-role-bindings" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank">优秀默认角色</a> <span> </span>。根据我的经验，在RBAC用户管理方面，这些默认的集群角色(查看、编辑、管理和集群管理)涵盖了大多数组织的绝大多数用例。</p>
<h2 id="4066" class="graf graf--h3 graf-after--p">尝试用RBAC管理器简化这一过程</h2>
<p name="b26f" id="b26f" class="graf graf--p graf-after--h3">我们对RBAC管理器的目标一直是让RBAC配置更容易使用。我们想要一种方法，它允许更简单的配置以及更直接的自动化途径。</p>
<h2 id="b7b7" class="graf graf--h4 graf-after--p">更简单的配置</h2>
<p name="6208" id="6208" class="graf graf--p graf-after--h4">RBAC管理器是一个Kubernetes操作员，监视新的或更新的<span> </span> <code class="markup--code markup--p-code">RBACDefinition</code> <span> </span>定制资源。为了创建上述场景的两个角色绑定，<span> </span> <code class="markup--code markup--p-code">RBACDefinition</code> <span> </span>需要大约一半的YAML配置:</p>
<pre><code>
apiVersion: rbacmanager.reactiveops.io/v1beta1 
kind: RBACDefinition 
metadata: 
    name: rbac-manager-config 
rbacBindings:
  - name: user-a-example 
    subjects: 
      - kind: User 
        name: A 
    roleBindings: 
      - clusterRole: edit 
        namespace: web 
      - clusterRole: edit 
        namespace: api</code></pre>
<section name="6c29" class="section section--body section--first">
<div class="section-content">
<div class="section-inner sectionLayout--insetColumn">
<p name="d468" id="d468" class="graf graf--p graf-after--figure">随着更多用户、名称空间或集群的加入，配置的减少只会变得更加显著。当然，RBAC还有比这个例子更多的东西。RBAC管理器支持在命名空间或集群级别将用户、组或服务帐户绑定到角色或集群角色的任意组合。</p>
<p name="6d8c" id="6d8c" class="graf graf--p graf-after--p">根据我们的经验，这种用单个定制资源分配多个角色绑定的能力非常强大。您不再需要寻找跨多个名称空间的角色绑定来理解您的RBAC配置的当前状态，取而代之的是它被整齐地总结在一个单一的RBAC定义中。</p>
<h2 id="417d" class="graf graf--h4 graf-after--p">自动化之路</h2>
<p name="fa83" id="fa83" class="graf graf--p graf-after--h4">RBAC管理器的设计理念是，我们希望在Kubernetes中实现RBAC管理的自动化。手动进行这些更改很容易出错，而且根本无法很好地扩展。不幸的是，这里现有的Kubernetes资源不能像部署那样自动更新。</p>
<p name="de03" id="de03" class="graf graf--p graf-after--p">考虑到这一点，RBAC定义的功能更像是部署，而不是角色绑定。就像部署简化了更新pod一样，RBAC定义旨在简化更新角色绑定和集群角色绑定。对RBAC定义的更改会触发其拥有的资源的更改，在本例中是角色绑定和集群角色绑定。如果RBAC定义中不再引用角色绑定，RBAC管理器会将其删除。同样，如果RBAC定义中请求的角色发生更改，RBAC管理器将删除并重新创建适当的角色绑定。最后，如果删除了RBAC定义，所有关联的角色绑定和集群角色绑定也将自动删除。</p>
<p name="3a7c" id="3a7c" class="graf graf--p graf-after--p graf--trailing">这种新方法打开了自动化的大门，并允许您使用CI工作流管理RBAC配置。与部署如何简化CI工作流中的pod更新类似，RBAC定义可以简化角色绑定和集群角色绑定的更新。</p>
</div>
</div>
</section>
<section name="dba2" class="section section--body section--last">
<div class="section-content">
<div class="section-inner sectionLayout--insetColumn">
<p name="4ad3" id="4ad3" class="graf graf--p graf--leading">在过去的几个月里，我们发现RBAC管理器对我们在<a href="/" rel=" noopener"> Fairwinds </a>的工作流程特别有用，我们希望您能像我们一样发现它的帮助。</p>
<p name="10c0" id="10c0" class="graf graf--p graf-after--p graf--trailing">这是一个完全开源的项目，我们很乐意接受你的任何想法或贡献。欲了解更多技术信息，或安装它，请访问我们的<span> </span> <a href="https://github.com/reactiveops/rbac-manager" data-href="https://github.com/reactiveops/rbac-manager" class="markup--anchor markup--p-anchor" rel="nofollow noopener" target="_blank"> GitHub </a>。请继续关注一些后续帖子，内容涉及我们如何使用RBAC管理器来管理AWS和GKE集群上的RBAC配置。</p>
</div>
</div>
</section></span></div>    
</body>
</html>