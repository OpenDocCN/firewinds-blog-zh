<html>
<head>
<title>K8s Tutorial: Use Polaris to Quickly Identify Kubernetes Security, Reliability and Efficiency Issues in Your Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>K8s教程:使用Polaris快速识别集群中的Kubernetes安全性、可靠性和效率问题</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/how-to-use-polaris-to-identify-kubernetes-security#2022-12-01">https://www.fairwinds.com/blog/how-to-use-polaris-to-identify-kubernetes-security#2022-12-01</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>Fairwinds的站点可靠性工程团队拥有为各种公司管理数百个Kubernetes集群的独特经验，他们发现客户经常将资源放入他们的集群，这导致他们的公司在云成本上花费额外的资金，使他们的应用程序不太可用，并使他们的集群容易受到恶意行为者的攻击。作为我们帮助客户缓解这些问题的努力的一部分，Fairwinds软件工程团队开发了一种自动检查这些问题的方法，并作为名为<a href="https://polaris.docs.fairwinds.com/"> Polaris </a>的开源项目发布了该工具。</p>

<p>Polaris运行数十项检查，以确保您的Kubernetes pods和控制器使用集群<a href="https://polaris.docs.fairwinds.com/checks/security/">安全性</a>、<a href="https://polaris.docs.fairwinds.com/checks/efficiency/">效率</a>和<a href="https://polaris.docs.fairwinds.com/checks/reliability/">可靠性</a>方面的最佳实践进行配置。北极星是一个强大的工具，因为你可以用三种不同的方式使用它。第一个是作为一个仪表板，可视化集群中当前运行的工作负载的问题。第二个是作为准入控制器，因此您可以自动拒绝不符合组织策略的工作负载。第三种是作为命令行工具，因此您可以在您的计算机上测试本地YAML文件，或者作为CI/CD过程的一部分。</p>
<p><img src="../Images/f4d53d4ed7d0cd46a221f3bfc43066c0.png" loading="lazy" alt="image of Polaris running checks" data-original-src="https://lh6.googleusercontent.com/4Z6ammLuWeraGZIdoU6Av9qSTi82JpYkaqN7YcoeEdcdTZgq1I4lxEglFYDHcYplfak5yAJjBauCfGJuJbDJ11O2XYKcve93E-NdwrsEB0ZLMz_HmGwMw8Qix3H18buAhakUeP85uFIUILJFBlK9GYk"/></p>
<p>在本教程中，我们将向您展示如何安装Polaris，并开始使用每种方法。</p>
<h2>安装和查看北极星仪表板</h2>
<p>Polaris dashboard旨在让您可视化集群中已经运行的有问题的工作负载。</p>
<p>在本教程中，我们将向您展示如何使用Helm安装Polaris，Helm是Kubernetes的软件包管理系统。如果你喜欢用另一种方式安装Polaris，可以从GitHub发布页面安装或者用T2自制软件安装。</p>
<p>要安装Polaris with Helm，首先，将fairwinds-stable图表库添加到本地可用的Helm图表中:</p>
<pre><code>helm repo add fairwinds-stable https://charts.fairwinds.com/stable</code></pre>
<p>接下来，在一个新的演示命名空间中创建一个名为polaris的Helm版本:</p>
<pre><code>helm upgrade --install polaris fairwinds-stable/polaris --namespace demo --create-namespace</code></pre>
<p>如果安装成功，您可以通过端口转发polaris-dashboard服务来启动仪表板:</p>
<pre><code>kubectl port-forward --namespace demo svc/polaris-dashboard 8080:80</code></pre>
<p>最后，在浏览器中打开<a href="https://localhost:8080/" rel="noopener" target="_blank"> https://localhost:8080 </a>查看Polaris仪表盘。</p>
<p>您将看到北极星仪表盘，上面有集群健康状况的概述，包括字母等级、通过检查的百分比分数，以及反映集群状态的天气报告，从“前方有风暴，小心”到“一帆风顺”。</p>
<p><img src="../Images/958d35282113386fa8a2da3b10ca3ae3.png" loading="lazy" alt="Image of Polaris dashboard" data-original-src="https://polaris.docs.fairwinds.com/img/dashboard-screenshot.png"/></p>
<p>要深入查看结果，您可以只查看标记为警告和危险的检查，或者按名称空间查看结果。</p>
<p>我们将在以后的博客文章中向您展示如何对修复进行优先级排序。</p>
<h2>将北极星设置为Kubernetes准入控制器</h2>
<p>Polaris可以被配置为一个<a href="https://kubernetes.io/docs/reference/access-authn-authz/admission-controllers/" rel="noopener" target="_blank">准入控制器</a>，它将扫描您试图部署的工作负载，并拒绝任何不符合Polaris标准的<a href="https://polaris.docs.fairwinds.com/checks/efficiency/">效率</a>、<a href="https://polaris.docs.fairwinds.com/checks/reliability/">可靠性</a>和<a href="https://polaris.docs.fairwinds.com/checks/security/">安全性</a>。</p>
<p>像安装仪表板的说明一样，本教程将向您展示如何使用Helm来安装Polaris并将其设置为验证webhook。</p>
<p>Polaris验证Webhook需要有效的TLS证书。如果您的群集中安装了cert-manager，则下面的安装方法将有效。</p>
<p>如果您不使用cert-manager，您需要:</p>
<ul>
<li aria-level="1">
<p>用webhook.caBundle提供一个CA包</p>
</li>
<li aria-level="1">
<p>使用使用该CA的有效证书在集群中创建TLS机密</p>
</li>
<li aria-level="1">
<p>使用webhook.secretName参数传递该机密的名称。</p>
</li>
</ul>
<p>首先，将顺风-稳定海图存储库添加到本地可用的舵图中:</p>
<pre><code>helm repo add fairwinds-stable https://charts.fairwinds.com/stable</code></pre>
<p>接下来，在一个新的演示命名空间中创建一个名为polaris的Helm release，启用webhook并禁用仪表板:</p>
<pre><code>helm upgrade --install polaris fairwinds-stable/polaris --namespace demo --create-namespace --set webhook.enable=true --set dashboard.enable=false</code></pre>
<p>如果安装成功，您将看到类似以下内容的消息:</p>
<pre><code>Release "polaris" does not exist. Installing it now.
NAME: polaris
LAST DEPLOYED: Thu Jul 28 19:56:21 2022
NAMESPACE: demo
STATUS: deployed
REVISION: 1
TEST SUITE: None
NOTES:
** Please be patient while the chart is being deployed **

Enjoy Polaris and smooth sailing!
To view the dashboard execute this command:

kubectl port-forward --namespace demo svc/polaris-dashboard 8080:80

Then open http://localhost:8080 in your browser.</code></pre>
<p>启用Polaris准入控制器后，当您尝试部署包含危险级别问题的工作负载时，验证webhook将阻止应用部署。</p>
<p>例如，如果开发人员试图部署一个名为basic-demo的不带image标记的Helm版本，他们将会看到一条类似于以下内容的错误消息:</p>
<pre><code>helm upgrade --install -n demo basic-demo fairwinds-incubator/basic-demo --create-namespace --set image.pullPolicy=IfNotPresent
Release "basic-demo" does not exist. Installing it now.

Error: admission webhook "polaris.fairwinds.com" denied the request:
Polaris prevented this deployment due to configuration problems:
- Container basic-demo: Image tag should be specified</code></pre>
<p>当开发人员添加图像标签并再次尝试部署基本演示版时，Polaris验证Webhook不会干扰，他们将会看到来自Helm的成功消息:</p>
<pre><code>Release "basic-demo" has been upgraded. Happy Helming!
NAME: app
LAST DEPLOYED: Fri Jul 29 16:07:35 2022
NAMESPACE: demo
STATUS: deployed
REVISION: 2
TEST SUITE: None
NOTES:
1. Get the application URL by running these commands:
  export POD_NAME=$(kubectl get pods --namespace staging-app -l "app.kubernetes.io/name=basic-demo,app.kubernetes.io/instance=app" -o jsonpath="{.items[0].metadata.name}")
  echo "Visit http://127.0.0.1:8080 to use your application"
  kubectl port-forward $POD_NAME 8080:80</code></pre>
<p>在未来的博客文章中，我们将描述如何设置变异的webhooks，以便在发现问题时自动改变部署。</p>
<h2>使用Polaris CLI工具审计您的基础设施代码</h2>
<p>使用Polaris的最后一种方法是使用命令行工具审计存储在YAML文件中的本地Kubernetes清单。这对于将Polaris作为CI/CD管道的一部分在您的基础设施代码上运行特别有帮助。</p>
<p>你可以使用<a href="https://polaris.docs.fairwinds.com/infrastructure-as-code/#install-the-cli">自制软件</a>或者从Github发布页面安装Polaris。</p>
<p>首先，访问<a href="https://github.com/fairwindsops/polaris/releases">版本页面</a>，找到适合您环境的版本。例如，在采用amd64处理器的Linux机器上，您将需要下载适用于Linux amd64的版本。</p>
<p>运行以下命令下载并安装Polaris:</p>
<pre><code>curl -L "https://github.com/FairwindsOps/polaris/releases/download/7.0.1/polaris_linux_amd64.tar.gz" &gt; polaris.tar.gz
tar -xvf polaris.tar.gz
sudo mv polaris /usr/local/bin/</code></pre>
<p>可以使用Polaris来审核您计算机上的Kubernetes yaml清单。例如，如果要扫描名为deploy的目录中的清单，请运行以下命令:</p>
<pre><code>polaris audit --audit-path ./deploy/ --format=pretty</code></pre>
<p>北极星将显示一个分数，并向您显示成功、警告和危险级别问题，如下所示:</p>
<pre><code>Polaris audited Path ./deploy/ at 2022-07-29T16:40:08-05:00
    Nodes: 0 | Namespaces: 0 | Controllers: 1
    Final score: 55

Deployment kube-info-deployment in namespace demo
    deploymentMissingReplicas            🎉 Success
        Reliability - Multiple replicas are scheduled
    hostIPCSet                           🎉 Success
        Security - Host IPC is not configured
    hostNetworkSet                       🎉 Success
        Security - Host network is not configured
    hostPIDSet                           🎉 Success
        Security - Host PID is not configured
  Container kube-info
    runAsPrivileged                      🎉 Success
        Security - Not running as privileged
    cpuLimitsMissing                     😬 Warning
        Efficiency - CPU limits should be set
    livenessProbeMissing                 😬 Warning
        Reliability - Liveness probe should be configured
    memoryLimitsMissing                  😬 Warning
        Efficiency - Memory limits should be set
    memoryRequestsMissing                😬 Warning
        Efficiency - Memory requests should be set
    privilegeEscalationAllowed           ❌ Danger
        Security - Privilege escalation should not be allowed
    readinessProbeMissing                😬 Warning
        Reliability - Readiness probe should be configured
    tagNotSpecified                      🎉 Success
        Reliability - Image tag is specified
    insecureCapabilities                 😬 Warning
        Security - Container should not have insecure capabilities
    runAsRootAllowed                     ❌ Danger
        Security - Should not be allowed to run as root
    cpuRequestsMissing                   😬 Warning
        Efficiency - CPU requests should be set
    dangerousCapabilities                🎉 Success
        Security - Container does not have any dangerous capabilities
    hostPortSet                          🎉 Success
        Security - Host port is not configured
    notReadOnlyRootFilesystem            😬 Warning
        Security - Filesystem should be read only
    pullPolicyNotAlways                  😬 Warning
        Reliability - Image pull policy should be "Always"</code></pre>
<p>Polaris还可以审计现有集群中的工作负载。确保您已经设置了KUBECONFIG文件，然后运行命令</p>
<pre><code>polaris audit --format=pretty</code></pre>
<p>在以后的文章中，我们将向您展示如何在CI/CD管道中使用Polaris。</p>
<h2>使用Polaris一次审计多个集群</h2>
<p>如果你有多个集群，并想用北极星一次性扫描它们，Fairwinds提供了一个名为<a href="https://www.fairwinds.com/insights"> Insights </a>的平台。用户可以跨集群一致地集中管理Polaris，以确保您的Kubernetes工作负载尽可能高效、可靠和安全。</p>
<h3>资源</h3>

<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-34aa4987-a1f9-438a-a145-d7d82d5c479a"><span class="hs-cta-node hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a" id="hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a"><img class="hs-cta-img" id="hs-cta-img-34aa4987-a1f9-438a-a145-d7d82d5c479a" src="../Images/7c86296320eb01b215d8e2755e9c5b9d.png" alt="Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a.png"/></a></span>T6】</span></p></span></div>    
</body>
</html>