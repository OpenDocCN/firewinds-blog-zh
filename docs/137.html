<html>
<head>
<title>How to Use Terraform with GKE: a Step-by-Step Guide to Deploying Your First Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何将Terraform与GKE一起使用:部署第一个集群的分步指南</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/how-to-use-terraform-with-gke-a-step-by-step-guide-to-deploying-your-first-cluster#2022-12-12">https://www.fairwinds.com/blog/how-to-use-terraform-with-gke-a-step-by-step-guide-to-deploying-your-first-cluster#2022-12-12</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>为了确保Kubernetes在构建基础设施方面的最佳实践，Fairwinds使用了提供一致性和定制性的通用模式。Terraform是我们管理基础设施整个生命周期的首选工具，以<a target="_blank" data-target-href="https://www.fairwinds.com/blog/why-infrastructure-as-code-kubernetes" href="https://www.fairwinds.com/blog/why-infrastructure-as-code-kubernetes" rel="noreferrer nofollow noopener">基础设施作为代码</a>。你可以在之前的博客中了解原因。</p>
<p>本博客提供了如何开始使用Terraform在GKE建立第一个Kubernetes集群的分步指南。</p>

<h2><strong> <span>先决条件</span> </strong></h2>
<p>如果您想在Terraform中创建自己的GKE集群，请遵循以下步骤。</p>

<ul>
<li><span>在您的Google Cloud帐户云控制台中创建一个项目</span><ul>
<li>一般会有一个默认创建的项目，你可以使用，或者点击Google云平台logo旁边的<code>My First Project</code> <span>下拉菜单，创建一个新项目。</span></li>
</ul>
</li>
</ul>
<p><img src="../Images/3fcb582de3d5d9a38825d47cb9e113c3.png" alt="GCP My First Project screenshot" srcset="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=880&amp;name=GCP%20My%20First%20Project%20screenshot.png 880w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=1760&amp;name=GCP%20My%20First%20Project%20screenshot.png 1760w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=2640&amp;name=GCP%20My%20First%20Project%20screenshot.png 2640w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=3520&amp;name=GCP%20My%20First%20Project%20screenshot.png 3520w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=4400&amp;name=GCP%20My%20First%20Project%20screenshot.png 4400w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=5280&amp;name=GCP%20My%20First%20Project%20screenshot.png 5280w" sizes="(max-width: 1760px) 100vw, 1760px" data-original-src="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20My%20First%20Project%20screenshot.png?width=1760&amp;name=GCP%20My%20First%20Project%20screenshot.png"/></p>
<ul>
<li><span>一旦创建了项目，并在下拉列表中选中了它，在左侧找到</span> <code>Kubernetes Engine → Configuration</code> <span>并启用Kubernetes引擎API，如下所示。</span></li>
</ul>
<p><img src="../Images/9aa1fcabc2c5e389768e8f4467473d08.png" alt="GCP Kubernetes Engine API Enable Screenshot" srcset="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=699&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 699w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=1398&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 1398w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=2097&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 2097w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=2796&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 2796w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=3495&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 3495w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=4194&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png 4194w" sizes="(max-width: 1398px) 100vw, 1398px" data-original-src="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png?width=1398&amp;name=GCP%20Kubernetes%20Engine%20API%20Enable%20Screenshot.png"/></p>



<h2><strong> <span>步骤</span> </strong></h2>
<p><span>在您的终端中，为您的Terraform文件创建一个项目目录，就像<code><span>terraform-gke</span>.</code>您创建的第一个文件将是Google Terraform Provider的文件，它让Terraform知道它可以创建什么类型的资源。</span></p>
<p><span>您将需要一个文件，其中包含Terraform与Google Cloud API交互以创建集群和相关网络组件所需的凭据。前往谷歌云控制台导航侧边栏的IAM &amp;管理部分，选择</span> <span> <code>Service Accounts.</code> </span>，创建一个服务帐户:</p>
<p><img src="../Images/f119ae23eecba7b15471f692c47e3df7.png" alt="GCP Screenshot IAM and ADMIN Service Accounts" srcset="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=800&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 800w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=1600&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 1600w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=2400&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 2400w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=3200&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 3200w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=4000&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 4000w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=4800&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png 4800w" sizes="(max-width: 1600px) 100vw, 1600px" data-original-src="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png?width=1600&amp;name=GCP%20Screenshot%20IAM%20and%20ADMIN%20Service%20Accounts.png"/></p>
<p><span>创建服务帐户后，系统会提示您为其选择一个角色。在本练习中，您可以从</span><span><span><code>Role</code></span>d</span><span>下拉菜单</span>中选择 <span/> <span> <code>Project: Owner</code> </span> <span/></p>
<p><span><img src="../Images/b39418ae8f7d75c57c8fa1ec896b86a0.png" alt="GCP Service Accounts Role ScreenShot" srcset="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=800&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 800w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=1600&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 1600w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=2400&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 2400w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=3200&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 3200w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=4000&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 4000w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=4800&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png 4800w" sizes="(max-width: 1600px) 100vw, 1600px" data-original-src="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Service%20Accounts%20Role%20ScreenShot.png?width=1600&amp;name=GCP%20Service%20Accounts%20Role%20ScreenShot.png"/>T2】</span></p>
<p>在下一页，点击<span> <code>CREATE KEY</code> </span>，选择一个JSON键类型:</p>
<p><img src="../Images/c2deb142ea430c2d0e21dfb28778832b.png" alt="GCP Create service account key screnshot" srcset="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=800&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 800w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=1600&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 1600w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=2400&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 2400w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=3200&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 3200w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=4000&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 4000w, https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=4800&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png 4800w" sizes="(max-width: 1600px) 100vw, 1600px" data-original-src="https://www.fairwinds.com/hs-fs/hubfs/Blog%20Images/GCP%20Create%20service%20account%20key%20screnshot.png?width=1600&amp;name=GCP%20Create%20service%20account%20key%20screnshot.png"/></p>
<p><span>一旦创建，文件将被下载到您的电脑上。将文件移动到Terraform项目目录。</span></p>
<p>接下来，创建一个名为<code>provider.tf,</code>的文件，并添加以下代码行:</p>
<pre><code>
provider "google" {
  credentials = file("./.json")
  project     = ""
  region      = "us-central1"
  version     = "~&gt; 2.5.0"
}
</code></pre>
<p>在项目名称中填入您在GCP控制台中创建的项目的ID，在凭证文件名中填入您刚刚下载并移动到项目文件夹中的服务帐户密钥文件的名称。完成后，创建一个名为<code>cluster.tf.</code>的新文件，添加以下代码来设置网络:</p>
<pre><code>
module "network" {
  source = "git@github.com:FairwindsOps/terraform-gcp-vpc-native.git//default?ref=default-v2.1.0"
  // base network parameters
  network_name     = "kube"
  subnetwork_name  = "kube-subnet"
  region           = "us-central1"
  enable_flow_logs = "false"
  // subnetwork primary and secondary CIDRS for IP aliasing
  subnetwork_range    = "10.40.0.0/16"
  subnetwork_pods     = "10.41.0.0/16"
  subnetwork_services = "10.42.0.0/16"
}
</code></pre>
<p>您将在<code>source</code>字段中注意到，网络模块是从我们的git repo中提取的:https://github . com/FairwindsOps/terra form-GCP-VPC-native/tree/master/default如果您研究该repo，尤其是<code>main.tf</code>文件，您将看到该模块负责创建的所有不同的资源和变量，如网络和子网，因此您不必单独创建它们。您可能会注意到，该模块也可以用于创建带有私有节点的云NAT，但是我们在这里将保持简单。接下来，将这个模块代码添加到集群本身的<code>cluster.tf</code>文件中:</p>
<pre><code>
module "cluster" {
  source                           = "git@github.com:FairwindsOps/terraform-gke.git//vpc-native?ref=vpc-native-v1.2.0"
  region                           = "us-central1"
  name                             = "gke-example"
  project                          = "terraform-module-cluster"
  network_name                     = "kube"
  nodes_subnetwork_name            = module.network.subnetwork
  kubernetes_version               = "1.16.10-gke.8"
  pods_secondary_ip_range_name     = module.network.gke_pods_1
  services_secondary_ip_range_name = module.network.gke_services_1
}
</code></pre>
<p>您会注意到某些值，如<code>module.network.network_name,</code>是从网络模块引用的。Terraform的这一特性使您能够在模块或资源上设置值，并在其他模块或资源上使用它们。最后，将这段代码添加到<code>cluster.tf</code>中，以设置包含Kubernetes工作节点的节点池:</p>
<pre><code>
module "node_pool" {
  source             = "git@github.com:/FairwindsOps/terraform-gke//node_pool?ref=node-pool-v3.0.0"
  name               = "gke-example-node-pool"
  region             = module.cluster.region
  gke_cluster_name   = module.cluster.name
  machine_type       = "n1-standard-4"
  min_node_count     = "1"
  max_node_count     = "2"
  kubernetes_version = module.cluster.kubernetes_version
}
</code></pre>
<p>就是这样！你的地形文件已经准备好了。下一步是通过运行<code>terraform init.</code>初始化terra form。terra form将生成一个名为<code>.terraform</code>的目录，并下载在<code>cluster.tf.</code>中声明的每个模块源。初始化将获取这些模块所需的任何提供程序，在本例中，它将下载<code>google</code>提供程序。如果进行了配置，Terraform还将配置用于存储状态文件的<code>backend</code>。</p>
<pre><code>
$ terraform init
Initializing modules...
Downloading git@github.com:FairwindsOps/terraform-gke.git?ref=vpc-native-v1.2.0 for cluster...
- cluster in .terraform/modules/cluster/vpc-native
Downloading git@github.com:FairwindsOps/terraform-gcp-vpc-native.git?ref=default-v2.1.0 for network...
- network in .terraform/modules/network/default
Downloading git@github.com:/FairwindsOps/terraform-gke?ref=node-pool-v3.0.0 for node_pool...
- node_pool in .terraform/modules/node_pool/node_pool

Initializing the backend...

Initializing provider plugins...
- Checking for available provider plugins...
- Downloading plugin for provider "google" (hashicorp/google) 2.20.3...
- Downloading plugin for provider "random" (hashicorp/random) 2.2.1...

The following providers do not have any version constraints in configuration,
so the latest version was installed.

To prevent automatic upgrades to new major versions that may contain breaking
changes, it is recommended to add version = "..." constraints to the
corresponding provider blocks in configuration, with the constraint strings
suggested below.

* provider.random: version = "~&gt; 2.2"

Terraform has been successfully initialized!

After Terraform has been successfully initialized, you should be able to run terraform plan. It is always a good idea to run terraform plan and review the output before allowing Terraform to make any changes. 

$ terraform plan
Refreshing Terraform state in-memory prior to plan...
The refreshed state will be used to calculate this plan, but will not be
persisted to local or remote state storage.
------------------------------------------------------------------------
An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  # module.cluster.google_container_cluster.cluster will be created
  + resource "google_container_cluster" "cluster" {
      + additional_zones            = (known after apply)
      ....
    }

  # module.network.google_compute_network.network will be created
  + resource "google_compute_network" "network" {
      + auto_create_subnetworks         = false
      ....
    }

  # module.network.google_compute_subnetwork.subnetwork will be created
  + resource "google_compute_subnetwork" "subnetwork" {
      + creation_timestamp       = (known after apply)
      ....
    }

  # module.node_pool.google_container_node_pool.node_pool will be created
  + resource "google_container_node_pool" "node_pool" {
      + cluster             = "gke-example"
      ....
    }

  # module.node_pool.random_id.entropy will be created
  + resource "random_id" "entropy" {
      + b64         = (known after apply)
      ....
    }

Plan: 5 to add, 0 to change, 0 to destroy.
</code></pre>
<p>请注意，这个片段已经被稍微编辑过，以减少这篇文章的篇幅。如上例所示，Terraform将采取措施添加我们的5个GKE资源。应用后，Terraform将创建我们的网络、子网(用于pod和服务)、GKE集群和节点池。<code>random_id</code>资源来自节点池模块；它用于跟踪节点池资源的更改。计划通过验证后，通过运行最后一个验证步骤<code>terraform apply.</code>应用更改，Terraform将再次输出计划，并在应用前提示确认。完成此步骤大约需要10-15分钟。</p>
<pre><code>
Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only 'yes' will be accepted to approve.

  Enter a value: yes

module.node_pool.random_id.entropy: Creating...
module.node_pool.random_id.entropy: Creation complete after 0s [id=dcY]
module.network.google_compute_network.network: Creating...
module.network.google_compute_network.network: Still creating... [10s elapsed]
module.network.google_compute_network.network: Creation complete after 17s [id=kube]
module.network.google_compute_subnetwork.subnetwork: Creating...
module.network.google_compute_subnetwork.subnetwork: Still creating... [10s elapsed]
...
module.network.google_compute_subnetwork.subnetwork: Creation complete after 37s [id=us-central1/kube-subnet]
module.cluster.google_container_cluster.cluster: Creating...
module.cluster.google_container_cluster.cluster: Still creating... [10s elapsed]
...
module.cluster.google_container_cluster.cluster: Still creating... [7m50s elapsed]
module.cluster.google_container_cluster.cluster: Creation complete after 7m56s [id=gke-example]
module.node_pool.google_container_node_pool.node_pool: Creating...
module.node_pool.google_container_node_pool.node_pool: Still creating... [10s elapsed]
module.node_pool.google_container_node_pool.node_pool: Still creating... [20s elapsed]
...
module.node_pool.google_container_node_pool.node_pool: Still creating... [2m0s elapsed]
module.node_pool.google_container_node_pool.node_pool: Creation complete after 2m7s [id=us-central1/gke-example/gke-example-node-pool-75c6]

Apply complete! Resources: 5 added, 0 changed, 0 destroyed.
</code></pre>
<p>请注意，这个片段已经被稍微编辑过，以减少这篇文章的篇幅。现在您的集群已经配置好了，使用gcloud来检索<code>kubectl.</code>的集群配置。该命令会将新的集群配置合并到您的<code>KUBECONFIG</code>中，默认为<code>~/.kube/config.</code></p>
<pre><code>
$ gcloud container clusters get-credentials gke-example --region us-central1
Fetching cluster endpoint and auth data.
kubeconfig entry generated for gke-example.
</code></pre>
<p>检索到凭据后，通过运行<code>kubectl get nodes.</code>确认您可以连接</p>
<pre><code>
$ kubectl get nodes
NAME                                                  STATUS   ROLES    AGE   VERSION
gke-gke-example-gke-example-node-pool-953475c5-lrm8   Ready       17m   v1.16.10-gke.8
gke-gke-example-gke-example-node-pool-d9071150-m8mh   Ready       17m   v1.16.10-gke.8
gke-gke-example-gke-example-node-pool-df7578a5-htw9   Ready       17m   v1.16.10-gke.8

</code></pre>
<p>恭喜您，您已经使用Terraform成功部署了Kubernetes GKE集群！您现在可以开始将您的应用程序部署到Kubernetes了！</p>
<h2>资源</h2>
</span></div>    
</body>
</html>