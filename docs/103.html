<html>
<head>
<title>K8s Tutorial: Using the Policy Engine, Polaris, to Automate Fixes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>K8s教程:使用Policy Engine，Polaris来自动修复</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/k8s-tutorial-policy-engine-polaris-to-automate-fixes#2022-12-01">https://www.fairwinds.com/blog/k8s-tutorial-policy-engine-polaris-to-automate-fixes#2022-12-01</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>在之前的一篇博文中，我们向您展示了如何安装policy engine，Polaris，以及如何使用仪表板、准入控制器和CLI工具审计您的Kubernetes工作负载。在本教程中，我们不仅仅看到Kubernetes的效率、可靠性和安全性问题，还将向您展示如何使用Polaris自动修复它发现的任何问题。</p>

<h2>使用Polaris CLI工具更新您的基础设施代码</h2>
<p>Polaris不仅仅可以从命令行审计文件。使用<span> polaris fix </span>命令，它可以自动修改它发现的任何问题的YAML清单。例如，要修复部署目录中的任何问题，请运行:</p>
<pre><code>polaris fix --files-path ./deploy/ --checks=all</code></pre>
<p>Polaris可能会在一些更改(例如，活性和就绪性探针)旁边留下注释，提示用户根据其应用的上下文将它们设置为更合适的内容。</p>
<p>并非所有问题都可以自动修复，目前只有原始YAML清单可以变异。舵图仍然需要手动更改(这方面的功能更新即将推出！).</p>
<h2>变异Webhook</h2>
<p>默认情况下，Polaris验证webhook将阻止或允许部署，但是您可以将Polaris配置为作为变异webhook运行，它会在发现问题时自动更改部署，而不是终止操作。</p>
<p>有关如何使用Helm安装验证webhook的说明，请参见<a href="https://polaris.docs.fairwinds.com/admission-controller/#installation"> Polaris文档</a>。</p>
<p>要启用变异webhook，您需要将<span> webhook.mutate </span>标志设置为true。完整的命令如下:</p>
<pre><code>helm upgrade --install polaris fairwinds-stable/polaris --namespace demo --create-namespace --set webhook.enable=true --set webhook.mutate=true --set dashboard.enable=false</code></pre>
<p>默认情况下，北极星变异webhook将改变的唯一问题是<span> pullPolicyNotAlways </span>。如果您想激活其他突变，您可以通过<a href="https://artifacthub.io/packages/helm/fairwinds-stable/polaris#values" rel="noopener" target="_blank"> webhook.mutatingRules </a>标志来定义它们，或者您可以编辑您的Polaris配置的<span> mutatingRules </span>部分:</p>
<pre><code>webhook:
  enableMutation: true
  mutatingRules:
  - cpuLimitsMissing
  - cpuRequestsMissing
  - dangerousCapabilities
  - deploymentMissingReplicas
  - hostIPCSet
  - hostNetworkSet
  - hostPIDSet
  - insecureCapabilities
  - livenessProbeMissing
  - memoryLimitsMissing
  - memoryRequestsMissing
  - notReadOnlyRootFilesystem
  - priorityClassNotSet
  - pullPolicyNotAlways
</code></pre>
<p>为了更深入地了解这一特性，请查看我们的博客文章<a href="https://www.fairwinds.com/blog/how-polaris-kubernetes-mutations-work"> Kubernetes与北极星的突变:它是如何工作的</a>。</p>
<p>对于手动将工作负载部署到Kubernetes集群的人来说,<span> polaris fix </span>命令和变异的webhook是一个很好的选择，但是如果你通过持续集成系统来验证你的代码和基础设施变化，你也可以使用polaris。</p>
<h2>将北极星添加到您的持续集成管道中</h2>
<p>Polaris可以在GitLab CI、Jenkins、CircleCI或CodeShip等持续集成系统中安装和运行。Polaris将强制您的部署过程在您设置的任何条件下退出。例如，如果Polaris检测到您的基础架构代码YAML文件或掌舵图存在某些问题，任何危险级别的问题，或者如果总得分低于75%，您可以设置退出代码。你可以配置Polaris只显示你失败的测试，并漂亮地打印出结果，以便人们更容易阅读。对于这组条件，CI管道中的Polaris配置如下所示:</p>
<pre><code>polaris audit --audit-path ./deploy/ \
  	--set-exit-code-on-danger \
  	--set-exit-code-below-score 75 \
	--only-show-failed-tests true \
	--format=pretty
</code></pre>
<p>这种方法不会自动修复Polaris发现的问题，但会显示CI系统日志中的错误。</p>
<p>也可以使用<a href="https://polaris.docs.fairwinds.com/infrastructure-as-code/#as-github-action" rel="noopener" target="_blank">北极星文档</a>中的说明在<a href="https://github.com/features/actions" rel="noopener" target="_blank"> GitHub操作</a>中设置北极星。</p>
<h2>一次在多个集群中使用北极星</h2>
<p>如果你有多个集群，并想用北极星一次性扫描它们，Fairwinds提供了一个名为<a href="https://www.fairwinds.com/insights"> Insights </a>的平台。用户可以跨集群一致地集中管理Polaris，以确保您的Kubernetes工作负载尽可能高效、可靠和安全。</p>
<h2>资源</h2>

<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-34aa4987-a1f9-438a-a145-d7d82d5c479a"><span class="hs-cta-node hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a" id="hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a"><img class="hs-cta-img" id="hs-cta-img-34aa4987-a1f9-438a-a145-d7d82d5c479a" src="../Images/7c86296320eb01b215d8e2755e9c5b9d.png" alt="Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a.png"/></a></span>T6】</span></p></span></div>    
</body>
</html>