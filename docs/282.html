<html>
<head>
<title>Running stateful application workloads in Kubernetes</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在Kubernetes中运行有状态应用程序工作负载</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/running-stateful-application-workloads-in-kubernetes#2020-01-31">https://www.fairwinds.com/blog/running-stateful-application-workloads-in-kubernetes#2020-01-31</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>我们从客户和潜在客户那里得到的最常见的问题之一是，“你会在Kubernetes上运行我们的数据库吗？”通常我们的答案是“不，你可能也不应该”，但在某些情况下，如果你愿意承担额外的工作和复杂性，运行数据库等有状态应用程序工作负载可能是正确的选择<em>。</em></p>

<h2>你从哪里开始？</h2>
<p>有很多原因(有些好，有些不好)让你希望在Kubernetes上运行数据库。除非这是一个真正的绿地项目，否则您可能已经在云提供商或数据中心愉快地运行了一个或多个数据库实例。</p>
<p>让我们检查一下你可能有的一些可能的原因，更重要的是，Kubernetes是可能有帮助还是有伤害。</p>
<p>也许你有一些Terraform或其他配置管理代码，允许你配置你的MySQL副本或你的Elasticsearch集群，但并不十分满意。或者您对它很满意，但是您希望集中在Kubernetes基础设施部署工作流上，这使得运行helm install mongodb变得非常诱人。也许你读过一篇文章，作者在Kubernetes上不到10分钟就创建了一个Wordpress实例。您可能一直在尝试手动管理PostgreSQL实例，但它并不可靠，而且您听说Kubernetes有助于提高应用程序的可靠性！也许您希望尽可能多地重用您的应用程序部署自动化，并且希望以与您的应用程序相同的方式部署您的Kafka实例。</p>
<p>所有这些场景有什么共同点？在Kubernetes集群上运行数据库与在metal或VMs上运行相同的数据库相比，工作量几乎相同或更少。抱歉，事实并非如此。复杂性是附加的。你仍然需要理解底层的数据库配置，如何优化它<em>以及</em>如何在Kubernetes上运行它。<strong> <em>生产数据商店可不好办。Kubernetes可能会很棘手</em>，使用Kubernetes的数据持久性可能会非常棘手。</strong></p>
<h2>考虑云中Kubernetes中的持久数据:</h2>
<p>自PetSets时代以来，Kubernetes中的StatefulSets已经走过了漫长的道路，但是旧名称表明了Kubernetes早期版本管理状态的意图。它把<a href="http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/" target="_blank" rel="noopener">【牛</a> <a href="http://cloudscaling.com/blog/cloud-computing/the-history-of-pets-vs-cattle/" target="_blank" rel="noopener">不是宠物】</a>的想法精确到了豆荚级。如果丢失一个实例(或者本例中的pod ),不管它恢复得多快，对您来说都是一个问题，那么在Kubernetes上管理它将是一个挑战。当它由于某种原因没有自动返回时，它会加倍。</p>
<p>当PersistentVolume EBS卷因为无法重新连接到集群中的某个节点(以及许多其他不幸事件)而被孤立时，Fairwinds已经有了相当多的午夜页面。值得庆幸的是，Kubernetes核心已经取得了很大进步，像<a href="https://rook.io/" target="_blank" rel="noopener"> Rook </a>和<a href="https://portworx.com/" target="_blank" rel="noopener"> Portworx </a>这样的新解决方案已经大大改善了Kubernetes的状态(只要你知道如何正确运行它们)。也就是说，在选择一个可以在Kubernetes上运行并保持健康的数据库时，有几件事你应该考虑。</p>
<p><strong><em><a href="https://kubernetes.io/docs/concepts/overview/what-is-kubernetes/" target="_blank" rel="noopener">Kubernetes</a>擅长什么？</em> </strong></p>
<ul>
<ul>
<li>服务发现和负载平衡</li>
<li>存储编排</li>
<li>自动化推出和回滚</li>
<li>箱型包装</li>
<li>自愈</li>
<li>机密和配置管理</li>
</ul>
</ul>
<p>这描绘了一个负载平衡连接的平台，可以在负载下水平扩展，自动在负载平衡器中发现新的工作负载实例，并替换失败的实例。对于无状态工作负载来说，这是编排的圣杯，但对于MySQL等传统数据库技术来说，这有点麻烦。看这张图，在Kubernetes上运行的最好的数据库类型是:</p>
<ul>
<ul>
<li>分布式的并且能够有多个副本，并且在丢失一些副本时仍然起作用，</li>
<li>短暂的，像缓存或开发环境。</li>
</ul>
</ul>
<p><strong> <em>不用担心，我正在使用&lt; </em>插入分片多对多复制数据存储<em> &gt;！</em> </strong></p>
<p>太好了，您正在Kubernetes上找到一个合理的数据库解决方案！假设:</p>
<ul>
<ul>
<li>您已经完成了所有的设置和调整，使其能够满足您的用例</li>
<li>您有一个可重复的部署方法。</li>
<li>社区掌舵图适合你，或者你有自己的专业知识来写。</li>
</ul>
</ul>
<p>你剩下要做的就是让它在Kubernetes上运行良好:考虑限制/资源、网络政策、Pod中断预算、自动扩展，并考虑在Kubernetes上运行任何应用程序的所有其他复杂因素</p>
<p>你需要多区吗？多地区？多云？如果您需要多区域或多云，很有可能您需要添加一个服务网格，如<a href="https://linkerd.io/" target="_blank" rel="noopener"> linkerd </a>或<a href="https://istio.io/" target="_blank" rel="noopener"> Istio </a>或添加到列表中，并且您需要解决延迟问题。您的PodDisruptionBudgets配置好了吗？在升级和停机期间，您能承受多少副本丢失？您是否正确配置了亲缘关系，以确保每个副本都位于不同的节点上？在AWS上，您的持久卷是否跨区域分布，然后当在没有持久卷的区域中调度实例时会发生什么？<strong> <em>生产数据商店可不好办。Kubernetes可能会很棘手，而Kubernetes的数据持久性可能会格外棘手</em> </strong></p>
<p><strong> <em>我的数据库不能牛怎么办？</em>T3】</strong></p>
<p>它是短暂的吗？如果不是这样，你<em>仍然可以在Kubernetes上用一个副本在StatefulSet中运行MySQL，就像你在大多数例子中看到的简单情况和你在设置Wordpress之类的东西时发现的情况一样，但是这样做你会削弱Kubernetes提供比运行“老学校”方式更高级别的服务的能力。如果没有负载平衡的副本，每当工作负载在节点之间移动时，您都会遇到服务中断。</em></p>
<p>如果它是短暂的，非生产性的，或者任何其他你可以在一段时间内不拥有它的情况，摇滚吧。</p>
<h2>你要去哪里？</h2>
<p><br/>在Fairwinds，我与一些组织进行了几次对话，他们希望摆脱数据专家，让他们的平台团队在Kubernetes上运行他们的数据存储，认为这将消除管理数据库的复杂性。现在你应该看到，在Kubernetes上运行你的数据库并没有消除复杂性，它<strong> <em>增加了</em> </strong>的复杂性。复杂性<em>可以</em>带来更高的服务质量，但这肯定不是灵丹妙药，而且做错的方法比做对的方法多。</p>
<p><strong> <em>好吧，那你推荐什么？</em>T3】</strong></p>
<ul>
<ul>
<li>您应该以适合您的方式和位置运行您的生产数据库。如果您和您的团队愿意投入大量精力来充分理解这样做的含义和要求，那么在Kubernetes上运行它会是一个很好的选择。<strong> <em>生产数据存储可能有些棘手。Kubernetes可能会很棘手，而Kubernetes的数据持久性可能会特别棘手。</em>T3】</strong></li>
<li>如果您选择这样做，我强烈建议<em>不要</em>在上运行与其他高可伸缩性工作负载混合在一起的有状态应用程序；使用单独的节点池或群集。针对快速扩展而优化的集群/节点池，在装载和卸载云卷以及移动副本时，您的持久状态更有可能出现问题。<em> <strong>生产数据商店可不好办。Kubernetes可能会很棘手，而Kubernetes的数据持久性可能会特别棘手。</strong> </em></li>
<li>不要解雇你的数据库管理员！Kubernetes上的数据库仍然需要数据库专家。这也需要Kubernetes的专家。<strong> <em>生产数据存储可能有些棘手。Kubernetes可能会很棘手，而Kubernetes的数据持久性可能会特别棘手。</em>T3】</strong></li>
<li>短暂的缓存和开发环境是可以的。如果您丢失了一个pod，重新装载卷或重新填充缓存需要大约90秒的时间，这种可能性很大。<strong> <em>这不是生产数据存储。</em>T3】</strong></li>
</ul>
</ul>
<p>您的里程可能会有所不同。需要进一步帮助吗？</p>
<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-947c4df4-0adc-4995-b455-8a656bbc764a"><span class="hs-cta-node hs-cta-947c4df4-0adc-4995-b455-8a656bbc764a" id="hs-cta-947c4df4-0adc-4995-b455-8a656bbc764a"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/947c4df4-0adc-4995-b455-8a656bbc764a"><img class="hs-cta-img" id="hs-cta-img-947c4df4-0adc-4995-b455-8a656bbc764a" src="../Images/53e8d84f66d88821bd9b2d3077c5a58e.png" alt="Set up a call" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/947c4df4-0adc-4995-b455-8a656bbc764a.png"/></a></span>T6】</span></p></span></div>    
</body>
</html>