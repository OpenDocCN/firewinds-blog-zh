<html>
<head>
<title>How to Adopt Istio into your Kubernetes Clusters</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>如何在您的Kubernetes集群中采用Istio</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/how-to-adopt-istio-into-your-kubernetes-clusters#2019-12-16">https://www.fairwinds.com/blog/how-to-adopt-istio-into-your-kubernetes-clusters#2019-12-16</a></blockquote><div><div class="post__content">
<p>最近，Istio受到了很多关注。服务网格平台最近达到了1.0生产就绪里程碑。谷歌一直在戏弄<a href="https://cloud.google.com/istio/" data-href="https://cloud.google.com/istio/" rel="nofollow noopener" target="_blank">谷歌云上的托管Istio选项</a>。在Kubernetes集群中有足够的资源让它运行。</p>
<p>你可能已经经历了科技炒作周期的各个阶段:</p>
<ol>
<li>什么是服务网格？</li>
<li>哇哦。服务网有点复杂。我真的需要一个吗？</li>
<li>好的。我可以看到一些使用案例。完成这个“<em>Istio Up&amp;15分钟跑完</em>”演示需要多少天的时间？</li>
</ol>
<p>现在，您已经实际上为您现有的Kubernetes托管应用程序设置了Istio。那要比15分钟长得多。这篇文章将告诉你如何将Istio引入你的Kubernetes集群。</p>
<h3>Istio到底是什么？</h3>
<p>如果没有别的，你可能听说过Istio是一个服务网格。“服务网格”是一个奇特的术语，指的是处理一组连接服务之间常见通信挑战的工具。</p>
<p>在现实世界中，Istio的架构建立在Kubernetes的基础上，增加了:</p>
<ul>
<li>用于服务之间的识别、授权和加密通信的相互TLS。</li>
<li>使用选择性白名单限制出站流量。</li>
<li>动态流量分布模式，如并发应用程序版本和渐进的金丝雀式部署。</li>
<li>通过断路器、重试处理、故障转移和对“混乱猴子”式故障注入测试的支持来提高弹性。</li>
<li>说明沟通模式和绩效的大量额外指标。</li>
</ul>
<p>Istio的架构通过在每个pod中运行一个单独的代理sidecar容器来实现这一切。一组核心服务在您的集群中运行，并与这些代理边盘通信，以实现上述功能。</p>
<h3>电脑:给我安装一个Istio</h3>
<p>Kubernetes上首选的Istio架构安装方法是<a href="https://helm.sh/" data-href="https://helm.sh/" rel="nofollow noopener" target="_blank">舵</a>图。请注意，<a href="https://github.com/istio/istio/tree/master/install/kubernetes/helm/istio" data-href="https://github.com/istio/istio/tree/master/install/kubernetes/helm/istio" rel="nofollow noopener" target="_blank"> Istio掌舵图</a>嵌入在Istio Github回购中。这是不可通过官方社区舵图表回购。</p>
<p>该图表安装了Istio运行所需的一组核心服务。它通过图表值提供了广泛的定制。它还支持升级到新的Istio版本。</p>
<p>在开始安装Istio之前，请继续阅读，了解一些在Kubernetes上安装和运行时特有的优势。</p>
<h4>你想如何在你所有的豆荚里安装边车代理？</h4>
<p>你所有的豆荚都需要一个边车代理容器。Istio可以将这个代理容器自动注入到新的pod中，而无需对部署进行任何更改。默认情况下该特性是启用的，但是它需要Kubernetes或更高版本。</p>
<p>您需要标记名称空间以启用边车注入:</p>
<pre>$ kubectl create namespace my-app
$ kubectl label namespace my-app istio-injection=enabled</pre>
<p>Istio chart安装不会影响现有的pod。在带标签的命名空间中启动的pod将接收sidecar，而在其他命名空间中启动的则不会。这为安装Istio的核心服务和有选择地将pod转移到网格中提供了一条途径。</p>
<h4>您将如何将服务过渡到互助TLS？</h4>
<p>Mutual TLS是一个有吸引力的安全特性，因为它限制了哪些服务可以相互通信，并且它对通信进行加密。但是，当您在转换服务时，它们需要与网格外部的资源进行通信，这可能会成为绊脚石。</p>
<p>为了简化这种转换，考虑<a href="https://istio.io/docs/tasks/security/mtls-migration/" data-href="https://istio.io/docs/tasks/security/mtls-migration/" rel="nofollow noopener" target="_blank">启用<em>许可</em>模式认证策略</a>。许可模式为服务启用明文HTTP和mTLS流量。该策略可以在网格策略中应用于集群范围，使用默认策略应用于每个命名空间，或者使用更细粒度的策略来针对单个服务。一旦您的应用程序完全迁移到Istio，您就可以禁用许可模式并强制实施相互TLS。</p>
<p>另一件要注意的事情是，典型的Kubernetes HTTP活跃度和就绪性探测在mTLS only模式下不起作用，因为探测来自服务网格之外。这些检查将在<em>许可</em>模式启用的情况下进行。一旦您取消<em>许可</em>模式，您将需要将探头转换为<em>执行</em>检查，以轮询pod内部的健康检查，或者在禁用mTLS的情况下在单独的端口上建立健康检查端点。</p>
<p>以下是创建网状策略的方法，该策略使整个集群的MTL处于许可模式:</p>
<pre>cat &lt;&lt;EOF | kubectl apply -f -
apiVersion: “authentication.istio.io/v1alpha1”
kind: “MeshPolicy”
metadata:
  name: “default”
spec:
  peers:
  — mtls:
      mode: PERMISSIVE
 EOF</pre>
<h4>您想在启用出口筛选的情况下开始吗？</h4>
<p>默认情况下，Istio <a href="https://istio.io/docs/tasks/traffic-management/egress/" data-href="https://istio.io/docs/tasks/traffic-management/egress/" rel="nofollow noopener" target="_blank">会限制您的pod的出站流量</a>。这意味着，如果您的pod与网格外部的服务进行通信，如云提供商API、第三方API或托管数据库，流量将被阻止。然后，您可以使用<a href="https://istio.io/docs/tasks/traffic-management/egress/#setting-route-rules-on-an-external-service" data-href="https://istio.io/docs/tasks/traffic-management/egress/#setting-route-rules-on-an-external-service" rel="nofollow noopener" target="_blank"> ServiceEntries </a>有选择地启用对外部服务的访问。</p>
<p>从表面上看，出口过滤似乎是一个有吸引力的安全功能。然而，它的实现方式并没有提供真正的安全优势。正如Istio的一篇文章中所解释的，没有任何机制可以确保被过滤的IP与名称相匹配。这意味着只需在HTTP请求中设置一个主机头就可以绕过过滤。</p>
<p>此外，作为现有应用程序的起点，出口过滤可能很困难。或者，您可以使用<a href="https://istio.io/docs/tasks/traffic-management/egress/#calling-external-services-directly" data-href="https://istio.io/docs/tasks/traffic-management/egress/#calling-external-services-directly" rel="nofollow noopener" target="_blank">全局<em>包含入口</em>设置</a>在集群级别禁用出口过滤。通过将此设置为集群的内部ip空间，您将绕过Istio代理处理所有外部流量。一旦在Istio中运行了服务，您就可以识别外部服务，并在打开出口过滤之前构建所需的<em>服务条目</em>。</p>
<p>以下头盔安装将完全禁用所有吊舱的出口过滤。您应该将内部集群IP CIDR添加到<em> includeIPRanges </em>设置中，以便通过Istio将流量从pod路由到内部资源，同时完全绕过外部端点。使用这两种配置中的任何一种，您都不需要为访问外部端点定义任何ServiceEntries。</p>
<pre>$ helm upgrade install/kubernetes/helm/istio — install \
  --name istio — namespace istio-system \
  --set global.tag=”1.1.0.snapshot.1" \
  --set global.proxy.includeIPRanges=””</pre>
<h4>Istio在设计上并不完全是Kubernetes本地的</h4>
<p>毫无疑问，Istio为Kubernetes上的部署提供了大量资源。有一个舵图表，其中有一系列子图表，用于安装大量与CRD相关的服务。有大量的文档和示例图表配置。然而，Istio的目标是独立于平台。考虑到这一点，在Kubernetes上部署支持Istio的应用程序有一些明显的不同。</p>
<p>最有影响力的差异之一在于在Istio网格之外公开服务。一个典型的Kubernetes应用程序使用一个连接到入口控制器的入口来公开一个外部接口。相反，Istio依赖于一个<a href="https://istio.io/docs/tasks/traffic-management/ingress/" data-href="https://istio.io/docs/tasks/traffic-management/ingress/" rel="nofollow noopener" target="_blank">网关对象</a>来定义协议设置，比如端口和TLS。网关对象与虚拟服务对象配对来控制路由细节。</p>
<p>这可能会影响您已经为入口对象(如域名和TLS证书管理)建立的模式。<a href="https://github.com/kubernetes-incubator/external-dns" data-href="https://github.com/kubernetes-incubator/external-dns" rel="nofollow noopener" target="_blank">外部dns </a>项目最近引入了对Istio网关对象的<a href="https://github.com/kubernetes-incubator/external-dns/releases/tag/v0.5.6" data-href="https://github.com/kubernetes-incubator/external-dns/releases/tag/v0.5.6" rel="nofollow noopener" target="_blank">支持，使得从入口对象到自动域管理的过渡更加容易。</a></p>
<p><em>网关</em>的TLS证书故事仍然有些复杂。Istio的<em> IngressGateway </em>不支持与<a href="https://github.com/jetstack/cert-manager" data-href="https://github.com/jetstack/cert-manager" rel="nofollow noopener" target="_blank"> cert-manager </a>兼容的多种证书，后者是一种从Kubernetes中自动提供和安装TLS证书的流行方式。证书更新需要滚动<em>ingress gateway</em>pod，这使得事情更加复杂。这使得在不按计划手动滚动pod的情况下，很难使用短期Let加密证书。即使使用静态证书，网关也会在启动时安装所有证书，因此为附加服务添加和删除证书也需要重新启动。共享一个网关的所有服务也可以访问所有其他服务的证书。</p>
<p>目前，在<em>网关</em>下开始使用TLS获取外部服务的最简单选项是:</p>
<ol>
<li>在类似Amazon弹性负载平衡器的地方终止网格外部的TLS，并让Amazon的证书管理器管理证书。</li>
<li>避免使用动态证书提供商，比如让我们在Istio <em> IngressGateway </em>上加密并安装多域或通配符TLS证书。</li>
</ol>
<h4>在Kubernetes上找到通往生产级Istio的道路</h4>
<p>现在您已经了解了Istio在Kubernetes上的一些优势，您可以继续在您的Kubernetes集群中安装Istio架构。这个帖子远没有提供生产级的配置。然而，它将使您的工作受到最小的干扰，以便您可以找到自己的工作生产配置之路。</p>
</div></div>    
</body>
</html>