<html>
<head>
<title>kops 102 - An Inside Look at Deploying Kubernetes on AWS the Fairwinds Way</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>kops 102 -在顺风航道上部署Kubernetes的内部观察</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/kops-an-inside-look-at-deploying-kubernetes-on-aws-the-fairwinds-way#2022-12-06">https://www.fairwinds.com/blog/kops-an-inside-look-at-deploying-kubernetes-on-aws-the-fairwinds-way#2022-12-06</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>在上一篇kops帖子中，<span> </span> <a href="http://blog.reactiveops.com/kops-the-kubernetes-deployment-game-changer"> kops 101 </a>，我介绍了kops是什么以及为什么它是专业级Kubernetes安装的正确选择。这一周，我将介绍如何用kops建立Kubernetes。</p>

<p>我想分享一个在AWS上带有<span> </span> <a href="https://github.com/kubernetes/kops" target="_blank" rel="noopener"> kops </a>的Fairwinds式<span/><a href="https://kubernetes.io/" target="_blank" rel="noopener">Kubernetes</a><span/>配置的例子。它包含了一个未记录的特性，DevOps社区可能会觉得非常有用。在我们谈得太远之前，我还想介绍一下<a href="/" rel=" noopener">风向</a>方式的想法。一个持续的试错过程使我们的团队能够以一种深思熟虑的、可重复的方式为创建基础设施设定最佳实践。这意味着我们有自己的观点并支持它。</p>
<p>就这样，让我们开始吧。</p>
<p>用kops the Fairwinds方法创建Kubernetes集群有两个步骤/组件:</p>
<ol>
<li>使用<span/><a href="https://www.terraform.io/" target="_blank" rel="noopener">terra form</a><span/>在<span> </span> <a href="https://aws.amazon.com/" target="_blank" rel="noopener">亚马逊Web服务</a> <span> </span> (AWS)上创建虚拟私有云(VPC)。</li>
<li>让kops处理所有其他事情，这意味着在同一个VPC中添加额外的网络资源，启动组成集群的实例并验证它是否工作。</li>
</ol>
<h2 id="step-1-configure-your-vpc">步骤1:配置您的VPC</h2>
<p>我们使用Terraform，一款由<span> </span> <a href="https://www.hashicorp.com/" target="_blank" rel="noopener">哈希公司</a>开发的开源基础设施管理和供应工具，来创建我们的基本VPC和网络布局。我们总是使用经过测试和验证的相同初始结构。我们创建的VPC旨在托管Kubernetes和我们可能希望Kubernetes与之交互的任何其他基于云的资源，如托管数据库、缓存和消息队列。</p>
<p>简单介绍一下我们的VPC能为您带来什么:</p>
<ul>
<li>多可用性区域(AZ)(通常为3个)</li>
<li>每个区域4组子网–1组面向公众，1组用于管理功能、私人工作和私人生产</li>
<li>每个AZ个AWS管理的NAT网关，私有子网中的资源可以通过该网关访问外部互联网</li>
</ul>
<p>VPC足够灵活，几乎可以应对我们范围内的任何情况，而且我们对其进行了精心设计，因此不会出现单点故障。</p>
<p>当然，你可以让kops为你创建VPC。这是默认模式，公平地说，这绝对是一种有吸引力的工作方式，特别是因为我们已经设计了kop来自动对您的基础架构做出明智的选择。然而，在<a href="/" rel=" noopener"> Fairwinds </a>，我们认识到Kubernetes只是高度复杂的生态系统中的一环。因此，我们用Terraform搭建舞台，然后让kops将Kubernetes放在舞台上。</p>
<h2 id="step-2-let-kops-work-its-magic">第二步:让kops发挥它的魔力</h2>
<p>现在我们已经有了VPC和基本的网络资源，我们可以进入特定于Kubernetes的配置了。</p>
<p>要从我们的Terraform VPC设置进入工作集群，请使用以下四个命令:</p>
<pre><code>kops create -f cluster_spec.yml 
kops create secret --name $CLUSTER_NAME sshpublickey admin -i $SSH_KEY_PATH 
kops update cluster $CLUSTER_NAME # Sanity check the output. Make sure that kops is 
only making the changes you expect. 
kops update cluster $CLUSTER_NAME --yes</code></pre>
<p>这真的是我们部署集群所需的全部吗？是也不是。虽然这可能不是您部署第一个集群的方式，但是一旦您浏览了几次，并且了解了集群规范的工作原理，这将是定义和创建集群的一个很好的方式。</p>
<p>因此，让我们花点时间来讨论集群规范。集群规范是kops的一个基本概念。不是所有的Kubernetes集群都有一个集群规范，但是所有kops创建的集群都有。集群规范是kops创建的yaml文档，它用代码定义了kops部署和管理集群所需的一切。它存在于你的州立商店里，对于AWS来说是在S3。如果您有一个集群规范，您就有了创建一个Kubernetes集群所必需的蓝图，这就是为什么我们只需要几个命令就可以创建一个Kubernetes集群(如上所示)。</p>
<p>如果您有一个使用kops构建的工作集群，并且您想要查看或保存集群规范，那么应该这样做:</p>
<pre><code>kops get cluster ${CLUSTER_NAME} -o yaml --full &gt; cluster.yml 
kops get ig nodes -o yaml &gt; nodes.yml 
kops get ig masters -o yaml &gt; master.yml 
… 
Merge the .yml files and put “---” between them into one large cluster_spec.yml See 
cluster_spec-example.yml</code></pre>
<p>与kop互动的方式有很多种，但这里我要强调kop一个相对不为人知的特性——通过<span> </span> <code>kops create -f</code>直接创建你的集群。此功能旨在镜像<span> </span> <code>kubectl create -f</code>，用于创建和配置所有类型的Kubernetes资源。在这里，kops一次性获取整个集群的规范，推断出任何未指定的值，然后创建您的集群。如果您正在编写集群部署的脚本或模板，这将非常有用(参见cluster_spec-template.yml.j2，了解如何开始考虑开发模板的一些想法)。</p>
<p>用kops创建集群的更广为人知的方法是使用一个脚本来包装包含在<span> </span> <code>deploy.sh</code>中的命令行标志。如果您运行<span> </span> <code>deploy.sh</code>，它将创建一个基本的集群规范，然后您可以立即部署该规范，或者通过<span> </span> <code>kops edit cluster</code>进行编辑以定制您的集群配置。最后可以用<span> </span> <code>kops update cluster</code>部署。但是对于那些习惯于完全自动化的剧本、食谱或其他自动化的基础设施管理方法的人来说，我上面描述的确实是交互式的，并且花费了操作员大量的时间。如果您正在进行任何定制(我们做了很多)，它也引入了出错的机会。那就是模板化和<span> </span> <code>kops create -f</code> <span> </span>进来的地方。</p>
<p>对于开发一致的、可重复的基础设施，我的建议是最初手工交互地创建几次集群，并密切关注集群规范如何响应您的更改。到那时，您将有一个满足您需求的基本规范，并且您可以使用它作为构建更多集群的模板。</p>
<p>请注意，我们将集群规范配置为在安全的私有拓扑中启动Kubernetes，这意味着主节点和节点位于私有子网中。kops创建了与私有子网1:1的“公用”子网。实用程序子网托管Kubernetes API服务器的弹性负载平衡器(ELB)、Kubernetes中启动的任何外部服务的elb以及bastion主机(如果使用的话)。</p>
<p>对于用kops创建的RO风格的Kubernetes集群，我们更喜欢让kops在我们现有的VPC中完全管理自己的配置(NAT网关除外)。我们发现，让kops控制网络、安全组和实例，可以让it部门优化对基础架构的升级和其他更改的管理。对于NAT网关，我们指导kop使用我们最初作为VPC创建的一部分生成的网关，因为它们是可扩展的和冗余的——并且相当昂贵。即使我们在VPC中有多个集群，我们也可以继续获得私有拓扑的好处，而不会增加相关的网络成本。</p>
<p>如果<span> </span> <code>kops update cluster</code>一切顺利，几分钟之内您就可以运行<span> </span> <code>kops validate cluster $CLUSTER_NAME</code> <span> </span>，并且知道您的集群已经准备就绪。</p>

<p>这种配置看起来很复杂。那么，我们为什么要这样工作呢？</p>
<p>简而言之，Terraform非常擅长打基础。它塑造了景观，并为Kubernetes创造了一个休息的地方。反过来，kops是专门为Kubernetes打造的。它是可预测的、快速的，可以处理所有的群集资源调配，并且比任何其他工具都更好地更新和管理群集。当你同时使用Terraform和kops时，你就拥有了完成手头任务的最佳工具。</p>
<p>以下是示例脚本、程序和规范的链接:<span/>【https://github.com/geojaz/ro-intro-to-kops-blog】T2</p></span></div>    
</body>
</html>