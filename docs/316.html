<html>
<head>
<title>Upgrading to Istio 1.</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>升级到Istio 1。</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/upgrading-to-istio-1.1#2020-07-28">https://www.fairwinds.com/blog/upgrading-to-istio-1.1#2020-07-28</a></blockquote><div><div class="post__content">
<p>Istio最近发布了其流行服务mesh的1.1.1版本，进行了一些更改和改进。毫无疑问，您应该从早期版本升级，以利用Kubernetes集群中的这些改进。但是升级并不简单——Istio的服务网几乎影响了集群通信的每个方面！除了升级Istio的控制面板，每个边车都必须升级。在接下来的部分中，我将概述一些应该计划的主要变化，以及在集群中升级Istio可以采取的步骤。</p>
<h2>有什么变化</h2>
<p>如果你是一个helm用户，需要注意的最大变化是CRD(自定义资源定义)现在由一个名为<code>istio-init</code>的单独的helm图表安装。这个新图表应该在控制面板升级之前安装，否则升级可能会失败。为了简化安装，添加了配置文件，它们是用于不同需求的舵值文件。</p>
<h3><a href="https://gist.github.com/mjhuber/247e04216c93bea5a93ecf7474762072#liveness-and-readiness-probes"/>活性和准备就绪探测</h3>
<p>在以前的版本中，当启用mTLS时，就绪性和活性探测一直是一个棘手的问题，因为kubelet没有istio颁发的证书来与服务通信。这使得使用http和tcp检查变得不可能。版本1.1引入了一个探针重写，可以将活跃度探针请求重定向到引导代理。然后，pilot代理将请求重定向到pod，允许kubelet在没有istio颁发的证书的情况下发送请求。换句话说，您可以再次使用http/tcp活跃度和就绪性探测！</p>
<h3><a href="https://gist.github.com/mjhuber/247e04216c93bea5a93ecf7474762072#mtls"/> mTLS</h3>
<p>如果您正在使用注释来覆盖mTLS策略，我很抱歉地说，这将不会继续下去。这已被一种用身份验证策略和目标规则替代的新方法所取代。使用策略和DestinationRule对象提供了更多的灵活性，但是在升级过程中您需要记住这一点。<strong><br/>T2】</strong></p>

<p><strong>边车</strong></p>
<p>在过去，很难配置超出开箱即用配置的代理边车。引入了一个新的sidecar资源，允许您配置代理将接受来自(入口和出口)的流量的端口和协议。该资源是动态的，您可以在一个名称空间中指定工作负载的子集来应用配置。<br/><strong><br/>T3】</strong></p>
<p><strong>入口</strong></p>
<p>在我看来最令人兴奋的变化是对istio ingress的弃用。这为更多的本地Kubernetes支持铺平了道路，随着这一变化，您可以使用Kubernetes ingress的可选支持。这允许您使用入口对象来定义入口点，并且您可以使用一个新的控制器来动态加载和旋转外部证书，包括LetsEncrypt。在<a target="_blank" data-target-href="https://istio.io/about/notes/1.1/" href="https://istio.io/about/notes/1.1/" rel="noreferrer nofollow noopener"> Istio 1.1发行说明</a>页面上可以详细查看这些变更以及其他一长串变更。</p>
<h2>升级过程</h2>
<p>升级通常是通过备份istio CRDs，安装新的<code>istio-init</code>舵图，用舵升级控制平面，然后升级所有的边车来完成的。<br/> <strong> <br/> </strong></p>
<p>备份您的CRD！</p>
<p>备份现有的CRDs是必要的，以防安装过程中出现问题。Kubectl让这变得非常简单:</p>

<p><strong>安装Istio初始化器图表</strong></p>
<p>一旦备份了CRDs，就该开始安装istio图表了。这些都可以在Istio repo中获得，所以我们需要首先使用下面的命令将其克隆到我们的工作站。所有适用的舵图都将在这个repo的<code>install/kubernetes/helm</code>子目录中。</p>

<p>如果你正在使用计算者，你很幸运，因为它可以从git repo安装图表。计算者是一个由<a href="/" rel=" noopener">费尔温德</a>开发的舵的命令行助手，它使用YAML语法在一个文件中安装和管理多个舵图表。</p>
<p>我们需要安装的第一个图表是名为<code>istio-init</code>的Istio初始化器图表。它管理istio需要的所有CRD。将这个图表安装到您已经安装了Istio的同一个名称空间是一个很好的做法。在这个例子中，我们在<code>istio-system</code>名称空间中有Istio。</p>
<p><code>helm install install/kubernetes/helm/istio-init --name istio-init --namespaceistio-system</code></p>
<p>如果您正在使用Reckoner，可以将此片段添加到您的课程中。yml:</p>

<p>然后，可以用命令<code>reckoner plot course.yml --heading istio-init</code>安装图表。</p>
<p>安装图表后，运行几个作业来创建CRD。在继续之前，您需要确保它们都已完成。您可以通过<code>watch</code>和<code>kubectl</code> : <code>watch -d "kubectl get job -n istio-system | grep istio-init-crd"</code>来监控状态</p>
<p><strong>升级控制平面</strong>流程的下一步是升级Istio控制平面。在你继续之前，有几个新的舵图表值需要注意:</p>

<p>一旦您的图表值配置完毕，您就可以使用helm: <code>helm upgrade istio install/kubernetes/helm/istio --namespace istio-system -f &lt;path-to-values&gt;.yml</code>升级版本了</p>
<p>这里有一个例子片段，你可以用它来升级Istio。可以使用命令<br/> <code>reckoner plot course.yml --heading istio</code>升级图表。</p>

<p><strong>升级边车</strong></p>
<p>升级控制面板后，所有使用istio的应用程序仍将使用旧版本的sidecar代理。随着豆荚被重新装载，他们将得到更新的边车。通过自然的pod重启来接收更新是完全可以接受的，但是您可能想要考虑触发所有部署的滚动更新，以使它们都在相同的sidecar版本上。Istio建议通过编辑每个启用了istio的部署规范中的普通字段来触发更新。这个代码片段通过向每个部署添加注释来实现这一点:</p>

<h2>祝你好运！</h2>
<p>享受升级后的Istio安装，它改进了对活性/就绪性探测的支持，更新了证书处理，并在Kubernetes生态系统中提供了更大的灵活性！</p>
</div></div>    
</body>
</html>