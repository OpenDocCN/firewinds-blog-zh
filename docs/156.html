<html>
<head>
<title>Security Basics for your first Kubernetes Cluster</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>第一个Kubernetes集群的安全基础</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/security-basics-for-your-first-kubernetes-cluster#2022-12-12">https://www.fairwinds.com/blog/security-basics-for-your-first-kubernetes-cluster#2022-12-12</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>所以你建立了一个集群。也许你已经部署了一些应用程序。你对库伯内特的事情很感兴趣。现在你做什么？</p>

<p>接下来可以做的事情很多。你可以安装一堆工具来让你的生活变得更轻松(无耻地塞给我的<a href="https://medium.com/uptime-99/kubernetes-202-making-it-fully-operational-7416e4bb15ab" target="_blank" rel="noreferrer noopener">上一篇文章</a>)。您可以开始部署应用程序并在生产中运行它们。或者，你可能在想“我到底要如何保护我刚刚放在云中的这个庞大复杂的东西呢?<em/>!？！?"这是一个有效的问题，我将尝试通过一系列易于遵循的实用步骤来回答这个问题。</p>
<p>免责声明:我并没有写一个关于保护集群安全的完整指南，也没有声称这些信息是完美的。这是一个起点，一种让大脑活跃起来的方式，一种开启全面安全计划之门的方式。</p>
<h3>GKE</h3>
<p>我完全在AWS中开始了我的Kubernetes之旅，并认为它是Bees Knees。然后，我发现了GKE(谷歌Kubernetes引擎)，并迅速改变了我的想法。这两个平台都很棒，也有各自的缺点，但如果你刚刚起步，GKE是一个很好的地方。</p>
<p>GKE最新的默认设置相当不错，而且还在不断改进，但是在设置集群时，您应该选择一些设置，这样您以后就能够做一些安全的事情。</p>
<h4>VPC本地集群</h4>
<p>首先要做的是打开VPC本地网络配置。这在GKE是相对较新的，很快将成为默认设置。它将集群放在VPC中，就像在AWS中一样。只差一个复选框，完全值得一试:</p>
<figure class="graf graf--figure graf-after--p">

<figcaption class="imageCaption">GKE VPC-Native Option</figcaption>
</figure>
<h4>集群访问</h4>
<p>完成后，我将浏览一组与集群网络相关的复选框。第一个在这里:</p>
<figure class="graf graf--figure graf-after--p">

<figcaption class="imageCaption">GKE Enable Master Authorized Networks</figcaption>
</figure>
<p>当你看到这里时，你可能会想“这个家伙不久前不是告诉我们IP白名单不是一种安全形式，我们应该停止这样做吗？”你在这一点上基本上是对的，我倾向于认为这一步基本上是不必要的。然而，作为更大的安全态势的一部分，这个设置可能是一个好主意。该设置将对主节点(和Kubernetes API)的访问限制在一组特定的IP地址。这并不意味着这些IP地址上的任何人都可以神奇地访问您的API，因为他们仍然需要通过Kubernetes进行身份验证才能做任何事情。它让你安心，如果Kubernetes(见<a href="https://github.com/kubernetes/kubernetes/issues/71411" target="_blank" rel="noreferrer noopener">CVE-2018–1002105</a>)出现严重漏洞，你有一点喘息的机会来修复它。这自然会对公共CI/CD工具和远程工作人员的可用性产生影响，但是如果您的集群的所有预期流量都来自单个网络内部，那么请务必打开“启用主授权网络”并将其设置为该IP CIDR块。</p>
<h4>网络策略</h4>
<p>我们要考虑的第三个复选框是<em>启用网络策略:</em></p>
<figure><img src="../Images/21459716d05989769d0e658091af3874.png" data-image="syck4lve7b94" data-original-src="https://cdn-images-1.medium.com/max/800/1*4JlOyb_igu6YhISeF-FMwg.png"/>
<figcaption>GKE Enable Network Policy</figcaption>
</figure>
<p>这个盒子听起来很棒，事实也的确如此。它支持名为“Calico”的网络策略实现，允许您创建Kubernetes <a href="https://kubernetes.io/docs/concepts/services-networking/network-policies/" target="_blank" rel="noreferrer noopener">网络策略</a>。反过来，这提供了严格限制集群中哪些东西可以与其他东西对话的能力。它并没有带来很多现成的好处，但它打开了通往安全世界的大门。如果你计划做高级网络策略，那么在开始的时候选中这个框会省去你一些麻烦。</p>
<h4>禁用旧身份验证</h4>
<p>最后一组框控制Kubernetes API的身份验证:</p>
<figure class="graf graf--figure graf-after--p">

<figcaption class="imageCaption">GKE Settings Security Section — Auth</figcaption>
</figure>
<p>很快，默认选项就足够了，但在此之前，您需要取消选中<em>启用遗留认证</em>、<em>发布客户端证书</em>和<em>启用遗留授权</em>。这将禁用基本身份验证，并强制所有用户使用GCP身份验证来访问群集。此外，Google默认启用RBAC，以便我们可以控制谁可以访问群集中的内容。稍后我将更详细地介绍这一点。</p>
<h3>AWS (kops)</h3>
<p>默认情况下，kops在VPC内部创建一个集群，其中节点位于专用子网中，主节点位于公共子网中，ELB用于API访问，ssh仅在内部可用。总的来说，这是一个很棒的网络配置，不需要太多改变。在这一点上向kops开发者脱帽致敬。但是，在创建集群时需要添加一些设置，以最大限度地提高安全性。</p>
<h4>集群访问</h4>
<p>首先，您可以启用一个可以访问主服务器的IP白名单(参见GKE部分了解我对此的想法)。您可以在kops集群yaml中通过添加这个珍闻并替换您的IP CIDR块来做到这一点:</p>
<pre><code>spec:
 kubernetesApiAccess:
 - 203.0.113.0/24</code></pre>
<h4>禁用匿名身份验证</h4>
<p>您可以做的另一个简单的改变是关闭kubelet的匿名认证。从<a href="https://github.com/kubernetes/kops/blob/master/docs/security.md#kubelet-api" target="_blank" rel="noreferrer noopener"> Kops安全</a>:</p>
<pre><code>spec:
 kubelet:
 anonymousAuth: false</code></pre>
<h4>网络策略</h4>
<p>如果您想启用网络策略，可以通过更改网络覆盖来实现。Calico或Canal都是支持网络政策的好选择。我不会在这里详细介绍它，但是kops有关于这个主题的大量文档。</p>
<h4>启用RBAC</h4>
<p>接下来，您需要确保在集群中启用了RBAC。这是新kops集群中的默认设置，但是值得检查一下集群规范:</p>
<pre><code>spec:
 authorization:
 rbac: {}</code></pre>
<h4>启用审核日志记录</h4>
<p>您想要的最后一个设置是打开审计日志记录。GKE默认给你这个，但是在kops中我们必须自己添加。在<a href="/" rel=" noopener"> Fairwinds </a>时，我们使用来自<a href="https://kubernetes.io/docs/tasks/debug-application-cluster/audit/" target="_blank" rel="noreferrer noopener"> Kubernetes文档</a>的以下配置:</p>

<h3>集群安全性</h3>
<p>一旦您使用所有这些选项构建了集群，您还可以做更多的事情来增强您的安全状况。</p>
<h4>使用RBAC</h4>
<p>现在启用了，就用吧。内置策略可能有用，但您也应该考虑自己的策略。此外，无论何时安装舵图，都要确保非常常见的<code>rbac.enabled: true</code>设置处于开启状态。这将创建特定于该应用程序的RBAC对象。去看看他们，看看他们做了什么。</p>
<p>使用<a href="https://github.com/reactiveops/rbac-manager" target="_blank" rel="noreferrer noopener"> RBAC管理器</a>简化角色绑定和集群角色绑定的创建。这将使您能够创建一个简单的CRD，将用户/组/服务帐户绑定到角色/集群角色。</p>
<p>最后，当你深入RBAC的杂草中，无论如何也想不出为什么有人能或不能接触到某样东西时，使用<a href="https://github.com/reactiveops/rbac-lookup" target="_blank" rel="noreferrer noopener"> RBAC查找</a>来查找。</p>
<figure><img src="../Images/69333e376fb852f5733482f952c29502.png" data-image="ukio0mbbnlj8" data-original-src="https://cdn-images-1.medium.com/max/800/1*TGd8tP-ohd27SRm7BClRfA.gif"/>
<figcaption>Brief Demo of rbac-lookup — <a href="https://asciinema.org/a/222327" target="_blank" rel="noreferrer noopener">https://asciinema.org/a/222327</a></figcaption>
</figure>
<h4>自由使用名称空间</h4>
<p>引用一位同事的话，“名称空间很便宜。”使用它们来分离基础设施工具和应用程序之类的东西。这允许您使用RBAC轻松限制访问，并限制应用程序的范围。当您决定创建网络策略时，我也会让它变得更容易。</p>
<h3>集装箱安全</h3>
<p>最后，我们需要保护我们在集群中运行的工作负载，因为这些工作负载将暴露给我们的(潜在的敌对)用户。在Kubernetes中运行容器时，有许多默认或常见的东西提供了不太理想的安全性。这里有一个你可以开始做的事情的非详尽列表。</p>
<h4>不要在每个容器中运行多个进程</h4>
<p>Docker通用最佳实践建议每个容器使用一个进程，这仅仅是出于可用性和大小的原因，实际上这也是一个很好的安全实践。它使您的攻击面保持较小，并限制了潜在漏洞的数量。</p>
<h4>不要以特权身份运行容器</h4>
<p>以特权身份运行容器或pod使其能够对主机进行修改。这是一个很大的安全问题，只要不去做就很容易缓解。</p>
<h4>不要以根用户的身份运行容器</h4>
<p>默认情况下，容器作为root用户在容器内运行。这很容易避免使用pod规范来设置高编号的UID。</p>
<pre><code>spec:
 securityContext:
 runAsUser: 10324</code></pre>
<h4>不要使用默认的功能列表</h4>
<p>默认情况下，Docker运行具有大量Linux功能的容器，其中许多功能您的应用程序可能并不需要。你可以在<a href="https://github.com/moby/moby/blob/master/oci/defaults.go#L14-L30" target="_blank" rel="noreferrer noopener">源代码</a>中看到它们。默认情况下，以下配置将删除所有Linux功能，允许您只添加应用程序实际需要的特定功能:</p>
<pre><code>spec:
 containers:
 - name: foo
 securityContext:
 capabilities:
 drop:
 - ALL</code></pre>
<h4>扫描容器中的漏洞</h4>
<p>已知漏洞占违规的很大一部分。使用工具来扫描您的容器，然后缓解它们。<a href="https://anchore.com/" target="_blank" rel="noreferrer noopener"> Anchore </a>、<a href="https://github.com/coreos/clair" target="_blank" rel="noreferrer noopener"> Clair </a>和<a href="https://quay.io/" target="_blank" rel="noreferrer noopener"> Quay </a>是我最喜欢的工具，但是还有其他的。</p>
<h4>看看KUBSEC。超正析象管(Image Orthicon)</h4>
<p>这个工具将分析您的部署yaml，并告诉您应该进行哪些更改，以提高这些pod的安全性。它甚至给你一个分数，你可以用它来建立一个最低标准。该分数包含了我上面概述的所有最佳实践，以及其他一些最佳实践。</p>
<p>下面是一个得分为9的部署示例:apiVersion: apps/v1</p>

<h3>不要停在这里</h3>
<p>一直都有关于Kubernetes和安全的新东西出现。去读一读，试一试。就在最近，我在CNCF博客上读到了<a href="https://www.cncf.io/blog/2019/01/14/9-kubernetes-security-best-practices-everyone-must-follow/" target="_blank" rel="noreferrer noopener">一篇文章，这篇文章很好地概述了安全最佳实践，并提醒了我一些我们应该做得更好的事情。安全是一个复杂的多层网络，不能用一种工具来解决，它永远不会“完成”，所以请不要在阅读本文后停止关心它。</a></p></span></div>    
</body>
</html>