<html>
<head>
<title>Kubernetes Basics Tutorial: Ensure Containers Do Not Run As Root</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>Kubernetes基础教程:确保容器不以Root用户身份运行</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/kubernetes-basics-tutorial-ensure-containers-do-not-run-as-root#2023-02-14">https://www.fairwinds.com/blog/kubernetes-basics-tutorial-ensure-containers-do-not-run-as-root#2023-02-14</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>容器是一个软件单元，它将代码及其所有依赖项集合在一起，使得在不同的计算环境中快速可靠地运行应用程序成为可能。Docker容器是独立的轻量级软件包，包含运行应用程序所需的一切，包括代码、系统工具、系统库、运行时和设置。容器映像在运行时成为容器，容器化的软件在任何基础设施中都以同样的方式运行。它们被称为容器，因为它们包含<strong><em/></strong>——它们将软件与环境隔离，并且它们被设计成统一运行。当然，Kubernetes是一个开源的容器编排系统。它自动化了软件部署、扩展和管理。Kubernetes使用pod作为最小的可部署单元，但是每个pod必须包含一个或多个容器。换句话说，没有容器你就不能真正拥有Kubernetes。</p>

<p>这就是为什么理解容器安全性以及容器的权限如何影响Kubernetes工作负载如此重要。<a href="https://media.defense.gov/2022/Aug/29/2003066362/-1/-1/0/CTR_KUBERNETES_HARDENING_GUIDANCE_1.2_20220829.PDF" rel="noopener" target="_blank"> <span>美国国家安全局的Kubernetes强化指南</span> </a>特别建议组织使用已经构建的容器作为非根用户运行应用程序。通常(默认情况下)，许多容器服务作为特权根用户运行，即使这些应用程序不需要特权执行。当您努力强化Kube环境时，您需要花一些时间调查哪些容器以root身份运行，然后进行更改以防止root执行，这样您就可以限制容器受损的影响。</p>
<h2><span> <span>检测允许作为根运行的容器</span> </span></h2>
<p><a href="https://www.fairwinds.com/polaris"> <span>北极星</span> </a>是一个验证Kubernetes配置的开源项目。它包含一个内置检查，专门用于检测允许以root用户身份运行的容器。Polaris内置于<a href="https://www.fairwinds.com/insights"><span>fair winds Insights</span></a>(如果您尚未使用Insights，则有一个免费层<a href="https://www.fairwinds.com/insights-pricing"> <span>可用于多达20个节点、两个集群和一个repo的环境</span>)，这使得Insights用户可以确切地看到集群中的哪些工作负载有权以root用户身份运行。您也可以在没有洞察力的情况下使用Polaris，它将帮助您确保您的容器以最小特权运行。Polaris策略可以帮助您避免权限提升，并确保您尽可能使用只读文件系统。Insights允许您运行相同的策略来查找允许在CI/CD管道中作为root运行的容器；这有助于确保基础设施代码的变化不会引入能够以root用户身份运行的新资源。</a></p>
<h2><span>见解行动项目</span></h2>
<p>Insights从安装的所有报告中收集数据，并将它们一起显示在仪表板中。如果你查看名为<span> <code>should not be allowed to run as root</code> </span>的动作项，你可以在截图中看到这是一个安全问题，严重性很高，北极星检测到了该问题。</p>
<p><img src="../Images/1030b0c70273a8bba69375bfa70b629c.png" loading="lazy" alt="Insights Action Items showing that containers should not be running as root" data-original-src="https://lh6.googleusercontent.com/y1rl-25yrbuifFWV0mX1EXQh59YwK6JvBZfvBPwYPVJIMk1-p_OVG7SBiYrtjJVeozw_AuUuaxVj1A_BrPCfS7moSHeJNNd6vYKvgdKW8q9e9BDXikRTMZstUNd4-m6W8n7Tvij-Nexlef4sd7PzFho"/></p>
<p>在操作项中，Insights包括关于Kubernetes对象类型、名称空间和Kubernetes对象名称的信息。您也可以点击标题来查看这些信息。现在，您可以轻松地确定需要更改的资源。Insights还显示一个描述部分，其中包括对行动项目的简短说明。</p>
<h2><span>补救问题</span></h2>
<p>“补救”部分提供了可用于补救措施项的步骤。对于此操作项，补救步骤要求您设置security context . runasnonroot = true，并提供了类似的示例。</p>
<p>要添加安全上下文参数，通常需要转到资源定义的源。这可能是存储库中的Helm值文件或平面清单文件，具体取决于您在环境中的部署方式。</p>
<p><img src="../Images/4ca64278e517c7a04ff7852274308d7d.png" loading="lazy" alt="Remediation step showing you need to set securityContext.runAsNonRoot=true" data-original-src="https://lh3.googleusercontent.com/xu1sYeMSW702r2dobRuZWYYa2XeMktUXDmpsHIBF0iCkNkZ3mGRjfHnEeBkZwPSGYDUSIFwNOJgF9vjvgFviQpaLG3IxSpS54KzVO0F95av1bPiTRRDtbVGxYB20lT9Em3o5esbkELzI_BtIEe7Iyo4"/></p>
<p>在<a href="https://training.fairwinds.com/action-item-ensure-containers-do-not-run-as-root"> <span>穿越视频</span> </a>中，我在本地机器上编辑了一个pod定义文件<span> </span> <span> <code>pod with nonroot.yaml</code> </span>文件。如修正步骤所示，您可以在pod或容器级别添加安全上下文。最好在pod级别添加这个安全上下文，因为它将是所有容器的默认上下文。如果您有令人信服的理由不在pod级别设置它，您将需要为pod中的每个容器设置它。</p>
<p>那么，如果您试图运行一个定义了这个安全上下文键的pod，会发生什么呢？在视频中，我做了一个<span> <code>k apply -f pod-with-nonroot.yaml</code> </span>来部署吊舱。(在我的系统上，我有一个别名为K的kube control。)当我按回车键时，你可以看到它说pod已经被创建了。但如果看pod，状态说，<span> <code>create container config error</code> </span>。这意味着pod实际上没有运行。你可以通过做一个<span> <code>k describe po pod-run-as-non-root</code> </span>来找出原因。</p>
<p>在显示的事件中，您可以看到一条消息，上面写着，<span> <code>Error: container has runAsNonRoot and image will run as root</code> </span>。由于该安全上下文设置，API服务器将不再启动此pod。这很好——您没有运行一个过度许可的容器。但是这很糟糕，因为现在你的容器根本不运行了。</p>
<h2>你如何修理集装箱？</h2>
<p>现在您有了一个不能在集群中运行的容器，您需要知道如何修复它。在Docker文件中，您可能希望创建自己的用户和/或组，并在运行入口点或命令参数之前切换到该实体。这将使容器按照docker文件中指定的用户运行。</p>
<p>或者，您可以在容器规范中使用<span> <code>RunAsUser</code> </span> <strong> </strong>指令。该键的值必须是用户ID，并且用户ID还必须是容器中存在的用户。请记住，当您以非Root用户身份运行您的容器时，您将希望确保您创建的用户拥有在您的容器内运行流程的正确权限。</p>
<p>不管在哪里定义替代非根用户，建议仍然将安全上下文设置为<span> <code>RunasNonRoot</code> </span>以增加容器的安全性。</p>
<h2><span>防御以根用户身份运行的工作负载</span></h2>
<p>一旦您更新了您的pod和containers，以确保它们不再能够以root身份跨您的工作负载运行，请考虑在Insights许可控制器中打开Polaris。这为在Kubernetes环境中以根用户身份运行的工作负载提供了最强有力的防御，能够从一开始就阻止这些工作负载进入您的集群。对于真正需要root访问权限的工作负载(不应该有很多)，您可以配置Insights来允许特定的豁免。为此使用一个允许列表，并在默认情况下拒绝以root用户身份运行，这将有助于确保您的容器尽可能安全地运行。</p>
</span></div>    
</body>
</html>