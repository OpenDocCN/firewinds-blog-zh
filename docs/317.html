<html>
<head>
<title>K8s Tutorial: Setting and Rightsizing Kubernetes Workloads with Goldilocks</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>K8s教程:使用Goldilocks设置和调整Kubernetes工作负载</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/setting-rightsizing-kubernetes-workloads#2023-01-10">https://www.fairwinds.com/blog/setting-rightsizing-kubernetes-workloads#2023-01-10</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p><span>优化Kubernetes集群的一个标准建议是确保在每个容器上设置</span> <a href="https://kubernetes.io/docs/concepts/configuration/manage-resources-containers/" rel="noopener" target="_blank"> CPU和内存请求和限制</a> <span>。这看起来很简单，但是您如何知道选择哪些值呢？</span></p>

<p>Fairwinds Goldilocks是一个开源实用程序，可以帮助您确定资源请求和限制的起点。像Goldilocks和Three Bears一样，这个工具可以帮助您确保在集群中为容器提供的空间不要太多，也不要太少，从而为您节省资金并防止潜在的应用程序中断。</p>
<p>在本教程中，我们将向您展示如何安装Goldilocks并利用它的建议。</p>
<h2><span>先决条件</span></h2>
<ul>
<li aria-level="1"><a href="https://kubernetes.io/docs/tasks/tools/" rel="noopener" target="_blank"> <span> kubectl </span> </a></li>
<li aria-level="1"><a href="https://helm.sh/docs/intro/install/" rel="noopener" target="_blank">舵</a></li>
<li aria-level="1">度量-服务器</li>
<li aria-level="1">垂直Pod自动缩放器</li>
<li aria-level="1">goldilocks-demo命名空间中的pod</li>
</ul>
<h2><span>安装先决条件</span></h2>
<p>Goldilocks要求您安装metrics-server和垂直Pod Autoscaler。这些说明将指导您如何使用Helm(Kubernetes的软件包管理系统)安装metrics-server和Vertical Pod Autoscaler。可以使用Kubernetes yaml清单来安装这些工作负载，您可以在<a href="https://github.com/kubernetes-sigs/metrics-server#installation" rel="noopener" target="_blank"> <span>度量-服务器文档</span> </a>和<a href="https://github.com/kubernetes/autoscaler/tree/master/vertical-pod-autoscaler#install-command" rel="noopener" target="_blank"> <span> VPA文档</span> </a>中找到如何安装的指导。</p>
<h3>安装度量标准-服务器</h3>
<p>将metrics-server图表存储库添加到本地可用的Helm图表中:</p>
<pre><code>helm repo add metrics-server https://kubernetes-sigs.github.io/metrics-server/</code></pre>
<p>接下来，在新的vpa名称空间中创建一个名为my-metrics-server的Helm版本:</p>
<pre><code>helm install my-metrics-server metrics-server/metrics-server --namespace vpa --create-namespace</code></pre>
<h3>安装vpn</h3>
<p>将顺风-稳定海图库添加到您本地可用的舵图中:</p>
<pre><code>helm repo add fairwinds-stable https://charts.fairwinds.com/stable</code></pre>
<p>接下来，在vpa命名空间中创建名为my-vpa的Helm版本:</p>
<pre><code>helm install -n vpa --create-namespace my-vpa fairwinds-stable/vpa</code></pre>
<h4>谷歌Kubernetes引擎(GKE)用户注意:</h4>
<p>VPA在<a href="https://cloud.google.com/kubernetes-engine/docs/concepts/autopilot-overview" rel="noopener" target="_blank"> <span>自动驾驶集群</span> </a>中默认启用，但在标准集群中必须手动启用。您可以像这样启用它:</p>
<pre><code> gcloud container clusters update [CLUSTER-NAME] --enable-vertical-pod-autoscaling {--region [REGION-NAME] | --zone [ZONE-NAME]} </code></pre>
<h2><span>配置金发女孩</span></h2>
<p>现在你已经设置好了先决条件，是时候使用Helm安装Goldilocks了。可以使用Kubernetes清单安装Goldilocks，你可以在<a href="https://goldilocks.docs.fairwinds.com/installation/#installation-2"> <span> Goldilocks docs </span> </a>中找到如何安装的说明。</p>
<h3>安装金发女孩</h3>
<p>创建一个名为my-goldilocks的头盔版本:</p>
<pre><code>	helm install -n goldilocks --create-namespace my-goldilocks fairwinds-stable/goldilocks 
</code></pre>
<h3>标记金发女孩将监视的名称空间</h3>
<p>在本例中，我们希望监控goldilocks-demo名称空间中的任何部署。我们必须标记名称空间，以便Goldilocks可以为名称空间中的每个部署创建一个VPA，然后查询它们的信息。</p>
<pre><code>kubectl label ns goldilocks-demo goldilocks.fairwinds.com/enabled=true</code></pre>
<h3>打开金发女孩仪表板</h3>
<p>端口转发金发女孩服务:</p>
<pre><code>kubectl -n goldilocks port-forward svc/my-goldilocks-dashboard 8080:80</code></pre>
<p>打开浏览器到<a href="http://localhost:8080/"><span>http://localhost:8080</span></a>查看仪表盘。您可能需要几分钟才能看到金发女孩的推荐。刷新浏览器可能会有所帮助。</p>
<h2><span>检查金发女孩的发现</span></h2>
<p>在这个例子中，我们在goldilocks-demo名称空间中有两个部署，每个部署都有一个相应的容器，echo-service和quote-service。</p>
<p><img src="../Images/dbbc2170560c57e23b92eacc87a04ade.png" loading="lazy" alt="View of the Goldilocks Dashboard analysis and recommendation for the echo-service." data-original-src="https://lh5.googleusercontent.com/RL8mEdEGgiTD8genL8aoBF4dNrj--yB0L_qnDtDOhys36_IWI73TvU17-mobmdvYzvnLV8xSwQtHKlARotTFNp2Q4aop5oS2iX1ncKbIn_dsR0N4i5l-F-Xc3zFMM3p_MGgIrgw0r6kPpE5Qku0"/></p>
<p><em>查看Goldilocks仪表盘分析和echo-service建议。</em></p>
<p>Goldilocks向我们展示了对于有保证的服务质量*，echo-service容器当前具有过高的CPU请求和限制，但是内存请求和限制刚刚好。在分析的下面是一个yaml片段，其中包含CPU和内存请求和限制的推荐值，您可以将其复制并粘贴到您的部署清单中。</p>
<p><img src="../Images/06147e58fd73c3862c9f1d0db33238ee.png" loading="lazy" alt="View of the Goldilocks Dashboard analysis and recommendation for the quote-service" data-original-src="https://lh3.googleusercontent.com/GyKDW9OJc7YkaVkUtd6_ixnjc9zo1YOJyhs4dyrPu3l46cv4zCS1ISYniPgBVqt3hS9lvoUYOjMUf-7dkmR_Y5sO55wppsvkBaqiR-ATCEzhIqSLAY6oxrM_4qZrlzb0cPbIcboxWJ8PQE0IvTc"/></p>
<p><em>查看Goldilocks仪表盘分析和报价服务建议。</em></p>
<p>对于报价部署容器，Goldilocks向我们展示了没有设置CPU或内存请求或限制。这是很危险的，因为容器可能会占用一个节点上的所有资源，挤走其他pods，使工作节点对Kubernetes控制平面不可用。建议的资源设置在分析下方。</p>
<h2><span>更新您的集装箱请求和限额</span></h2>
<p>复制并粘贴建议的资源请求和限制后，您应该更新您的部署并刷新Goldilocks仪表板。您将看到Goldilocks指出您当前的CPU和内存请求和限制符合建议。祝贺您使您的资源请求恰到好处！</p>
<p><img src="../Images/377e8ecd79c60cfbf00d8af482807488.png" loading="lazy" alt="View of the Goldilocks Dashboard analysis for the echo-service where the current resource requests are in line with the recommendations." data-original-src="https://lh6.googleusercontent.com/O3Xr9kfqPkPYnCM8s3P5GZIvKV23wwEfoUL9j35s0WbrYyN5fbKOjxtTrgVxk1SCgn7QIwPdqIS8LkzWyJlPl9sbIYm7qeMH_PBAeNKNEnEkSZYHmUJKGqjNd-dzHOctdx10Q2cqs1gVea9-AE4"/></p>
<p><em>echo服务的Goldilocks仪表板分析视图，其中当前资源请求符合建议。</em></p>
<p><img src="../Images/53e63b6cc387330bd88279183f428930.png" loading="lazy" alt="View of the Goldilocks Dashboard analysis for the quote-service where the current resource requests are in line with the recommendations" data-original-src="https://lh5.googleusercontent.com/LHOuLyG8JpW_gxnbweNxyP9augf3PIUERK8h4h6LBei06-sLQMwkCEHa2GPQvw2gzXiUA2gqTLI2kSFg-ryan_IfiWFiSy_j6b78kW6eM9q_x-x5wa6bzu1_7zclXED30M5PUMrVMLz_1xwWVg8"/> <span> <em>当前资源请求符合建议的报价服务的Goldilocks仪表板分析视图。</em> </span></p>
<p>您的pod存在的时间越长，VPA收集的数据就越多，所以一定要随时查看Goldilocks仪表板，因为建议可能会发生变化。</p>
<h2>大规模应用金发女孩的优势</h2>
<p>如果你有多个集群和用户，并希望大规模应用金发女孩的优势，Fairwinds提供了一个名为Insights的平台。用户可以跨集群一致地集中管理Goldilocks，以确保有效地设置CPU和内存请求和限制。Fairwinds Insights通过提供<a href="https://www.fairwinds.com/kubernetes-cost-optimization"><span>Kubernetes</span></a>的成本优化建议而更进一步。</p>
<p>对使用Fairwinds Insights感兴趣吗？免费提供！<a href="https://www.fairwinds.com/coming-soon"> <span>在此了解更多</span> </a>。</p>
<h2><span>资源</span></h2>

<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-34aa4987-a1f9-438a-a145-d7d82d5c479a"><span class="hs-cta-node hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a" id="hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a"><img class="hs-cta-img" id="hs-cta-img-34aa4987-a1f9-438a-a145-d7d82d5c479a" src="../Images/7c86296320eb01b215d8e2755e9c5b9d.png" alt="Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a.png"/></a></span>T6】</span></p>
<p><span>*“QoS(服务质量)等级是基于其资源请求和限制分配给pod的名称。Kubernetes使用QoS等级来决定调度和驱逐pod。<span/> </span> <a href="https://kubernetes.io/docs/tasks/configure-pod-container/quality-service-pod/" rel="noopener" target="_blank"> Kubernetes文档:为Pods配置服务质量</a></p></span></div>    
</body>
</html>