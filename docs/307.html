<html>
<head>
<title>How we manage Kubernetes RBAC and IAM Roles on GKE</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>我们如何管理Kubernetes RBAC和我在GKE的角色</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/how-we-manage-kubernetes-rbac-and-iam-roles-on-gke#2022-12-12">https://www.fairwinds.com/blog/how-we-manage-kubernetes-rbac-and-iam-roles-on-gke#2022-12-12</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>Google的托管Kubernetes服务一直是我最喜欢的运行Kubernetes集群的方式之一。谷歌Kubernetes引擎(GKE)提供了一些令人难以置信的功能，使Kubernetes更愉快地工作。也就是说，GKE最好的功能之一是经常被误解的，Google Cloud IAM和Kubernetes RBAC之间的关系。如果配置正确，它们可以为Kubernetes授权提供一种简单而强大的方法。</p>

<h4>RBAC建立在GKE的基础上</h4>
<p>对于Google Cloud中的大多数服务，设置授权只需要配置IAM角色。虽然这也是GKE的一个选项，但是您可能需要添加一些RBAC配置，作为有效的Kubernetes授权策略的一部分。</p>
<p>本质上，所有IAM配置都适用于整个Google Cloud项目，以及该项目中的所有集群。Kubernetes RBAC配置分别应用于每个集群，并支持名称空间级别的细粒度授权。在GKE中，这些授权方法并行工作，用户的能力有效地代表了分配给他们的IAM和RBAC角色的联合。</p>
<h4>常见的IAM和RBAC角色</h4>
<p>Google Cloud IAM和Kubernetes RBAC都提供了默认角色，作为任何授权策略的良好起点。</p>
<figure><img data-src="https://cdn-images-1.medium.com/max/1600/1*_XD1aE2-NIcRPF7S1fFBwg.png" src="../Images/a9b2184be193e0f73607198cae823d65.png" data-image="2tpdhhh8s6rf" data-original-src="https://cdn-images-1.medium.com/max/1600/1*_XD1aE2-NIcRPF7S1fFBwg.png"/>
<figcaption>GCP IAM and Kubernetes RBAC have similarly named roles (cluster admin, admin, developer/edit, and viewer)</figcaption>
</figure>
<p>根据上图，您可能会认为左边的Google Cloud IAM角色与右边相应的Kubernetes RBAC角色相匹配。虽然这基本上是对的，但是在集群管理员角色方面有很大的不同。</p>
<p>在Kubernetes RBAC中，集群管理员角色授予创建、编辑或删除集群中任何资源的完全管理权限。使用Google Cloud IAM，Kubernetes引擎集群管理员角色实际上只授予更改集群基础设施的能力，而不是实际访问集群中的任何资源。当然，这两个角色名称在单独使用时是有意义的，但是考虑到IAM和RBAC的效果之间的重叠，这种命名可能会令人困惑。以下是IAM角色与RBAC角色实际关联的大概情况:</p>
<figure><img data-src="https://cdn-images-1.medium.com/max/1600/1*8krA85JXr4IcNxe8fs_uRg.png" src="../Images/1f4bb62fa47826e86a4a908642fc3598.png" data-image="c72y1y25360w" data-original-src="https://cdn-images-1.medium.com/max/1600/1*8krA85JXr4IcNxe8fs_uRg.png"/>
<figcaption>The GKE Admin role actually matches up more closely with the cluster-admin RBAC role while the GKE developer and viewer roles line up closely with RBAC edit and view roles.</figcaption>
</figure>
<p>这些IAM角色与RBAC角色并不完全匹配，但是这些箭头所连接的角色中的功能通常非常接近。还值得注意的是，项目范围的所有者、编辑者和查看者IAM角色分别包括GKE管理员、开发人员和查看者功能(有几个有趣的例外)。</p>
<h4>一起使用IAM和RBAC</h4>
<p>有了最小特权原则作为我们的指路明灯，我们可以使用简单的方法与IAM和RBAC一起实现全面授权。由于IAM角色授予对GCP项目中所有集群的访问权限，因此应该谨慎使用。例如，授予“Kubernetes Engine Developer”角色将授予对所有名称空间的编辑访问权，包括<code>kube-system</code>允许具有此IAM角色的任何人修改核心系统组件。当然，我们仍然需要使用IAM授予某种形式的基本访问权限，以使用户能够获得访问集群的凭证。在GKE上，如果没有至少一些IAM来授予初始集群访问权限，RBAC是无能为力的。</p>
<p>考虑到这一点，我们通常建议使用“Kubernetes引擎查看器”IAM角色来授予只读访问权限。然后，可以使用粒度RBAC配置来扩展这种访问，该配置授予对特定名称空间的写和/或管理访问权限。对于GKE，IAM是授权的基础，而RBAC是建立在基础之上的结构。</p>
<p>实际上，这意味着在名称空间级别向特定用户授予集群中的<code>edit</code>或<code>admin</code>角色，以构建您使用IAM授予他们的只读访问权限。一个简单的角色绑定在<code>web</code>名称空间中授予Jane edit访问权限，如下所示:</p>
<pre>kind: RoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: jane-web
  namespace: web
subjects:
- kind: User
  name: jane@example.com
  apiGroup: rbac.authorization.k8s.io
roleRef:
  kind: ClusterRole
  name: edit
  apiGroup: rbac.authorization.k8s.io
</pre>
<p> </p>
<p>像这样定义RBAC配置在小范围内工作得相对较好，但是很快会变得难以跨各种名称空间或用户进行管理。当一半的配置位于Google Cloud IAM，而另一半位于RBAC的Kubernetes时，也很难获得集群中授权的全貌。在不断遇到这些问题后，我们创建了一些开源工具来帮助解决。</p>
<h4>简化RBAC管理</h4>
<p>在Fairwinds，我们为各种各样的组织管理集群，这意味着我们亲眼目睹了RBAC配置在规模上可以变得多么复杂。更糟糕的是，很难以任何有意义的方式自动化对RBAC配置的更改。像许多组织一样，我们尽可能使用CI/CD和基础设施作为代码，这对RBAC来说确实很难。角色绑定不能更改，而是需要在为用户分配不同角色时删除并重新创建。此外，在任何CI/CD工作流中，注意到缺少资源并基于此进行更改变得非常复杂。对于RBAC，这是一个非常重要的细节。撤销访问需要移除角色绑定，这可能很难跟踪。</p>
<p>我们在构建rbac管理器时考虑到了所有这些因素。rbac-manager是一个定制运营商，可以轻松部署到您的集群中，显著简化您的rbac工作流。使用rbac-manager的自定义资源(rbac定义)，我们经常看到yaml的数量减少到原始配置的1/3。重要的是，使用rbac-manager更改和撤销角色的工作方式与您预期的一样。如果绑定到用户的角色在RBAC定义中发生更改，rbac-manager会负责删除和重新创建与新角色绑定的关联角色。此外，如果从RBAC定义中删除了与用户绑定的角色，则关联的角色绑定也会自动删除。</p>
<p>所有这些改进都相对较小，但是当组合成一个单一的工具时，它们可以使RBAC更容易使用。</p>
<h4>简化RBAC(和IAM)的可见性</h4>
<p>借助GKE提供的RBAC和IAM的独特组合，很难全面了解谁有权访问集群。我们创建了<a href="https://github.com/reactiveops/rbac-lookup" data-href="https://github.com/reactiveops/rbac-lookup" rel="noopener nofollow" target="_blank"> rbac-lookup </a>来帮助解决这个问题。使用类似于<code>rbac-lookup rob</code>的简单命令，它将输出所有匹配该名称的用户、服务帐户或组，并显示他们在集群中被赋予的RBAC角色。</p>
<p>在我们最新的版本中，我们引入了GKE IAM集成，这也将在输出中包括与这些用户相关联的容器IAM角色。因此，如果您运行<code>rbac-lookup rob --gke</code>，它将包括所有相关的RBAC角色，以及与匹配用户的GKE访问相关联的所有相关IAM角色。</p>
<p>在Fairwinds，我们相信在您的Kubernetes集群上配置和理解授权应该很容易。我们希望<a href="https://github.com/reactiveops/rbac-manager" data-href="https://github.com/reactiveops/rbac-manager" rel="nofollow noopener" target="_blank"> rbac-manager </a>和<a href="http://github.com/reactiveops/rbac-lookup" data-href="http://github.com/reactiveops/rbac-lookup" rel="nofollow noopener" target="_blank"> rbac-lookup </a>都有助于让每个人更容易接近rbac。</p>
<p> </p>
<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-cb39a009-a458-4282-9211-41e010cb3376"><span class="hs-cta-node hs-cta-cb39a009-a458-4282-9211-41e010cb3376" id="hs-cta-cb39a009-a458-4282-9211-41e010cb3376"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/cb39a009-a458-4282-9211-41e010cb3376" target="_blank" rel="noopener"><img class="hs-cta-img" id="hs-cta-img-cb39a009-a458-4282-9211-41e010cb3376" src="../Images/c38df324d5163c7ccc9c6b998a78ad26.png" alt="Download Kubernetes Best Practices Whitepaper" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/cb39a009-a458-4282-9211-41e010cb3376.png"/></a></span>T6】</span></p></span></div>    
</body>
</html>