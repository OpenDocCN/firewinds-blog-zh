<html>
<head>
<title>Operate Kubernetes in a Multi-Cluster, Multi-Cloud World</title>
<link href="../Styles/Style.css" type="text/css" rel="stylesheet"/>
</head>
<body>
<h1>在多集群、多云计算环境中运营Kubernetes</h1>
<blockquote>原文：<a href="https://www.fairwinds.com/blog/how-to-operate-kubernetes-in-a-multi-cluster-multi-cloud-world#2022-11-29">https://www.fairwinds.com/blog/how-to-operate-kubernetes-in-a-multi-cluster-multi-cloud-world#2022-11-29</a></blockquote><div><span id="hs_cos_wrapper_post_body" class="hs_cos_wrapper hs_cos_wrapper_meta_field hs_cos_wrapper_type_rich_text" data-hs-cos-general-type="meta_field" data-hs-cos-type="rich_text"><p>当跨多个云帐户操作多个Kubernetes集群时，如何在最大限度地减少意外更改的同时提高工作效率？在这篇文章中，我将分享一些最佳实践和开源工具，Fairwinds的团队认为这些对Kubernetes从业者很有价值。您还可以观看一个附带视频的<a href="https://youtu.be/Btbqir4UAA8" rel="noopener" target="_blank">来观看解说视频。</a></p>

<h2>库贝特尔</h2>
<p>在<a href="https://kubernetes.io/docs/tasks/tools/install-kubectl/" target="_blank" rel="noopener">安装kubectl </a>时，Kubernetes命令行界面为Bash或Zsh配置shell完成。这允许您按Tab来完成kubectl命令和Kubernetes资源名称，比如部署或pod。确保安装了bash-completion先决条件包。上面指向kubectl安装文档的链接包括设置其shell完成的细节。</p>
<pre><code>laptop:~$ kubectl get pod [tab]app-7f5fd6f95c-[tab twice]
app-7f5fd6f95c-bnkwj app-7f5fd6f95c-lg9pg
laptop:~$ kubectl get pod app-7f5fd6f95c-b[tab]nkwj
</code></pre>
<p>上面的例子使用tab来帮助完成一个kubectl get pod命令。因为两个pod共享相同的“7f...5c”字符串，按tab键两次会显示两个窗格。然后，我键入“b”作为决胜符，并再次按tab来完成我想要的pod的名称。</p>
<p>也可以用tab键补全我可能会忘记的命令名，比如kubectl api-resources。</p>
<h3>在集群和名称空间之间切换</h3>
<p>没有什么比意外地在不同的Kubernetes集群中进行更改更能影响您一天的轨迹了——“哦，不，我以为我在staging中删除了那个负载平衡器服务！”</p>
<p>kubectl使用的Kubernetes客户机配置将访问参数分组到上下文中。每个上下文都指一个集群、一个用户和当前的默认名称空间。在一个Kubernetes客户机配置文件中可能有多个上下文，分别代表不同的临时和生产Kubernetes集群。</p>
<p>kubectl命令可用于在单个Kubernetes客户端配置(KubeConfig)文件中定义的多个上下文之间切换，如关于多集群访问的Kubernetes <a href="https://kubernetes.io/docs/tasks/access-application-cluster/configure-access-multiple-clusters/" target="_blank" rel="noopener">文档中所述。然而，</a><a href="https://github.com/ahmetb/kubectx" target="_blank" rel="noopener"> kubectx和kubens </a>工具使得在上下文之间切换和设置当前名称空间变得更加容易。对于没有Bash或ZSH的微软Windows用户来说，这些工具直接支持Windows，并且在Golang中进行了相对较新的重写。</p>
<h3>分离Kubernetes上下文</h3>
<p>为每个环境使用单独的KubeConfig文件，需要更明确的操作来使用特定的上下文或集群。将KUBECONFIG环境变量设置为要使用的KubeConfig文件。默认情况下，这可以避免同时访问所有集群。给Kubernetes contexts起一个有意义的名字，并在shell提示符下显示当前的上下文也是有帮助的——下面将详细介绍。</p>
<h3>Extend Kubectl</h3>
<p>kubectl命令可以使用插件来扩展——要了解更多关于如何增强kubectl命令行的技巧，请查看我们关于<a href="https://www.fairwinds.com/blog/help-improve-your-kubectl-command-with-plugins" target="_self"> kubectl插件和krew插件管理器</a>的博文，并查看这些Krew插件:</p>
<ul>
<li><a href="https://github.com/FairwindsOps/rbac-lookup" target="_blank" rel="noopener">RBAC-查找</a> -轻松查找与任何用户、服务帐户或组相关的角色和集群角色</li>
<li>谁能显示哪些主题拥有RBAC权限</li>
<li><a href="https://cert-manager.io/docs/usage/kubectl-plugin/" target="_blank" rel="noopener">证书管理器</a> -帮助管理由证书管理器群集附加组件管理的资源</li>
</ul>
<h2>管理不同版本的工具</h2>
<p>升级是一种持续的生活方式，您可能有不同版本的Kubernetes、Helm或其他基础设施管理工具，如Terraform。理想情况下，<a href="https://kubernetes.io/docs/setup/release/version-skew-policy/" target="_blank" rel="noopener">版本的kubectl与</a>版本的Kubernetes API相匹配，团队中的每个人都使用相同版本的Helm来管理集群插件或应用程序。一个版本管理器，如<a href="https://asdf-vm.com/#/" target="_blank" rel="noopener"> asdf </a>，管理命令行工具的多个版本，以及Python、Node或Ruby等语言。asdf工具版本文件可以包含在项目或存储库目录的顶部，以便根据当前工作目录配置使用哪个版本的工具。asdf工具使用<a href="https://asdf-vm.com/#/plugins-all" rel="noopener" target="_blank">插件</a>来支持许多工具和语言。</p>
<pre><code>laptop:~$ asdf plugin add kubectl
laptop:~$ asdf list all kubectl
…..
1.19.2
1.19.3
1.20.0-alpha.1
1.20.0-alpha.2
…..
laptop:~$ asdf install kubectl 1.19.3
Downloading kubectl from https://storage.googleapis.com/kubernetes-release/release/v1.19.3/bin/darwin/amd64/kubectl
laptop:~$ cd /path/to/project/directory
laptop:~$ asdf local kubectl 1.19.3
laptop:~$ cat .tool-versions
kubectl 1.19.3
</code></pre>
<p> </p>
<p>上面的例子为kubectl添加了asdf插件，列出了可用的kubectl版本，安装了1.19.3版本，并配置了一个项目目录以使用该版本的kubectl。</p>
<p>Asdf还支持使用环境变量来配置使用哪个版本的工具，如果您的工作流有助于改变您的环境而不是依赖于当前的工作目录。例如，将ASDF _库ECTL_VERSION环境变量设置为“1.19.3”。</p>
<h2>多个云帐户</h2>
<p>有时，有必要检查Kubernetes节点的计算实例，这可能跨越多个环境，这些环境可能使用不同的云帐户、项目或订阅。<a href="https://docs.aws.amazon.com/cli/latest/userguide/cli-configure-envvars.html" target="_blank" rel="noopener"> AWS </a>、<a href="https://cloud.google.com/sdk/gcloud/reference/config" target="_blank" rel="noopener"> Google </a>和<a href="https://docs.microsoft.com/en-us/cli/azure/azure-cli-configuration" target="_blank" rel="noopener"> Azure </a>的云命令行接口支持使用环境变量控制配置。这些环境变量可以使用<a href="https://direnv.net/" target="_blank" rel="noopener"> direnv </a>工具基于您当前的工作目录进行更改，该工具在您“cd”到一个目录时设置环境变量。</p>
<h3>亚马逊网络服务</h3>
<p>使用aws configure - profile …命令为每个环境配置一个配置文件，并通过- profile命令行参数或AWS_PROFILE环境变量使用该配置文件。</p>
<pre><code>laptop:~$ aws configure --profile production
AWS Access Key ID [None]: xxxxx
AWS Secret Access Key [None]: yyyyy
Default region name [None]: us-east-2
Default output format [None]: text
laptop:~$ aws --profile production s3 ls
…..
laptop:~$ export AWS_PROFILE=production # Use this profile while the variable is set
</code></pre>
<h3>谷歌云</h3>
<p>使用g cloud config configuration s create命令为每个环境创建一个单独的配置。使用gcloud config set命令来设置Google帐户和项目等属性。通过CLOUDSDK_ACTIVE_CONFIG_NAME环境变量指定哪个配置是活动的。</p>
<pre><code>laptop:~$ gcloud config configurations create qa
Created [qa].
Activated [qa].
laptop:~$ gcloud config set account ivan@fairwinds.com
Updated property [core/account].
laptop:~$ gcloud config set project qa                
Updated property [core/project].
WARNING: You do not appear to have access to project [qa] or it does not exist.
laptop:~$ export CLOUDSDK_ACTIVE_CONFIG_NAME=qa # Use this configuration while the variable is set
laptop:~$ gcloud auth login
…..
laptop:~$ gcloud auth application-default login # Optional, if using tools like Terraform
</code></pre>
<h3>蔚蓝色的云</h3>
<p>为每个环境的命令行配置文件使用单独的目录。设置AZURE_CONFIG_DIR环境变量，然后使用az login和az account set命令为该环境配置AZURE命令行。</p>
<pre><code>laptop:~$ export AZURE_CONFIG_DIR=~/infra/test/.azure
laptop:~$ az account show # demonstrates this is a new config
Please run 'az login' to setup account.
laptop:~$ az login
…..
laptop:~$ az account set --subscription xxxxx
</code></pre>
<h2>我在哪里？在你的提示中反映事情</h2>
<p>快速灵活的<a href="https://starship.rs/" target="_blank" rel="noopener"> Starship </a>提示符定制工具可以在您的shell提示符中显示Kubernetes和云信息，以帮助了解哪个Kubernetes集群和云帐户是活动的。<a href="https://starship.rs/config/#kubernetes" target="_blank" rel="noopener"> Kubernetes组件</a>显示当前的上下文，也可以显示KubeConfig文件中定义的当前名称空间。还有<a href="https://starship.rs/config/#aws" target="_blank" rel="noopener"> AWS </a>和<a href="https://starship.rs/config/#gcloud" target="_blank" rel="noopener"> gcloud </a>组件来包含关于那些云的信息。<a href="https://starship.rs/config/#environment-variable" target="_blank" rel="noopener">环境变量</a>和<a href="https://starship.rs/config/#custom-commands" target="_blank" rel="noopener">定制命令</a>组件可用于提供额外的上下文，包括活动Azure订阅。</p>
<p>请看随附的视频，及其<a href="https://github.com/FairwindsOps/how-to-kube/blob/master/blog-multiple-clusters-and-clouds/starship.toml" target="_blank" rel="noopener">示例星舰配置</a>。我们希望这有助于您跨多个云操作Kubernetes集群。</p>
<p> </p>

<p> </p>
<p><span class="hs-cta-wrapper" id="hs-cta-wrapper-34aa4987-a1f9-438a-a145-d7d82d5c479a"><span class="hs-cta-node hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a" id="hs-cta-34aa4987-a1f9-438a-a145-d7d82d5c479a"><a href="https://cta-redirect.hubspot.com/cta/redirect/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a"><img class="hs-cta-img" id="hs-cta-img-34aa4987-a1f9-438a-a145-d7d82d5c479a" src="../Images/7c86296320eb01b215d8e2755e9c5b9d.png" alt="Use Fairwinds Insights for Free Security, Cost and Developer Enablement In One" data-original-src="https://no-cache.hubspot.com/cta/default/2184645/34aa4987-a1f9-438a-a145-d7d82d5c479a.png"/></a></span>T6】</span></p></span></div>    
</body>
</html>